# Nano Banana Pro é›†æˆæ¶æ„è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ä¸šåŠ¡èƒŒæ™¯
åŸºäº nano banana pro æ–‡ç”Ÿå›¾æ¨¡å‹çš„å¼ºå¤§èƒ½åŠ›ï¼Œå®ç°ä»ä¼ ç»Ÿæ¨¡æ¿å¥—å†…å®¹åˆ°ç›´æ¥ç”Ÿæˆ PPT å›¾ç‰‡çš„è½¬å˜ï¼Œæ˜¾è‘—æå‡ PPT æ’ç‰ˆçš„è§†è§‰æ•ˆæœå’Œç¾è§‚åº¦ã€‚

### 1.2 æ¶æ„ç›®æ ‡
- æ— ç¼é›†æˆç°æœ‰ AI PPTist ç³»ç»Ÿ
- æä¾›é«˜æ•ˆçš„å›¾ç‰‡æ‰¹é‡ç”Ÿæˆèƒ½åŠ›
- ç¡®ä¿ç”Ÿæˆè¿‡ç¨‹çš„å¯è§‚æµ‹æ€§å’Œå¯æ§åˆ¶æ€§
- æ”¯æŒæ¨¡æ¿åŒ–ç”Ÿæˆå’Œä¸ªæ€§åŒ–å®šåˆ¶
- ä¿è¯ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œç¨³å®šæ€§

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®¢æˆ·ç«¯å±‚ (Vue 3)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ AIPPTå¯¹è¯æ¡†  â”‚ â”‚ æ¨¡æ¿é€‰æ‹©å™¨    â”‚ â”‚  å¹»ç¯ç‰‡ç¼–è¾‘ç•Œé¢           â”‚    â”‚
â”‚  â”‚ (å¤§çº²ç”Ÿæˆ)   â”‚ â”‚ (ğŸŒé¦™è•‰ç”Ÿæˆ)  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â””â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ç¼©ç•¥å›¾â”‚ â”‚ è¿›åº¦æµ®çª—  â”‚  â”‚    â”‚
â”‚       â”‚                â”‚           â”‚  â””â”€â”€â”€vâ”€â”€â”˜ â””â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚       â”‚                â”‚           â”‚      â”‚          â”‚       â”‚    â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ HTTP/HTTPS 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APIç½‘å…³å±‚ (FastAPI)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ ç”Ÿæˆæ¥å£ â”‚  â”‚ æ¨¡æ¿æ¥å£ â”‚  â”‚ è¿›åº¦æ¥å£ â”‚  â”‚ å›è°ƒæ¥å£ â”‚            â”‚
â”‚  â”‚ (SSE)   â”‚ â”‚ (REST)   â”‚ â”‚ (REST)   â”‚â”‚ (WebHook)â”‚            â”‚
â”‚  â””â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚            â”‚               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸šåŠ¡æœåŠ¡å±‚ (Python)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚          Nano Banana é›†æˆæœåŠ¡ (æ ¸å¿ƒæœåŠ¡)                  â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚  - æ¨¡æ¿ç®¡ç†æœåŠ¡                                           â”‚      â”‚
â”‚  â”‚  - ç”Ÿæˆä»»åŠ¡ç¼–æ’æœåŠ¡                                        â”‚      â”‚
â”‚  â”‚  - è¿›åº¦ç®¡ç†æœåŠ¡                                           â”‚      â”‚
â”‚  â”‚  - é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶                                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                      â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      AIæ¨¡å‹é€‚é…å±‚ (Provider)           â”‚  â”‚    ç¼“å­˜æœåŠ¡     â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  (Redis)        â”‚    â”‚
â”‚  â”‚  - OpenAI Provider                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚  - Gemini Provider                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - Nano Banana Pro Provider           â”‚  â”‚   å›¾ç‰‡ä»“åº“      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  (è…¾è®¯äº‘COS)    â”‚    â”‚
â”‚                  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ PostgreSQL â”‚   Redis    â”‚   MinIO    â”‚   å‘é‡DB    â”‚            â”‚
â”‚  â”‚ (ä¸šåŠ¡æ•°æ®) â”‚  (ç¼“å­˜/é”) â”‚  (æºæ–‡ä»¶)  â”‚ (æ¨¡æ¿ç´¢å¼•) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 2.2.1 æ¨¡æ¿ç®¡ç†æ¨¡å— (å‰ç«¯é™æ€é…ç½®)

**èŒè´£**:
- æä¾›é¢„è®¾æ¨¡æ¿å›¾ç‰‡ä¾›ç”¨æˆ·é€‰æ‹©
- æ”¯æŒå¿«é€Ÿè¿­ä»£çš„æ¨¡æ¿æ›´æ–°
- æ— éœ€åç«¯æ•°æ®åº“æ”¯æŒï¼Œä¾¿äºå¿«é€ŸDEMOéªŒè¯

**å®ç°æ–¹å¼ (å‚è€ƒç°æœ‰ç³»ç»Ÿ)**:

1. **æ¨¡æ¿é…ç½® (å‰ç«¯ä»£ç )**:
```typescript
// frontend/src/configs/nanoBananaTemplates.ts
export const NANO_BANANA_TEMPLATES: SlideTemplate[] = [
  {
    id: 'nano_banana_1',
    name: 'ä¸“ä¸šå•†åŠ¡é£',
    cover: './imgs/nano_banana/business_pro.png',
    description: 'é€‚åˆå•†åŠ¡æ±‡æŠ¥çš„è“è‰²ä¸»é¢˜',
    metadata: {
      style: 'professional',
      color_scheme: ['#2563eb', '#1e40af', '#1e3a8a'],
      recommended_for: ['business', 'presentation', 'report']
    }
  },
  {
    id: 'nano_banana_2',
    name: 'ç§‘æŠ€æœªæ¥æ„Ÿ',
    cover: './imgs/nano_banana/tech_future.png',
    description: 'ç§‘æŠ€æ„Ÿåè¶³çš„æ·±è‰²ä¸»é¢˜',
    metadata: {
      style: 'tech',
      color_scheme: ['#0ea5e9', '#8b5cf6', '#ec4899'],
      recommended_for: ['tech', 'innovation', 'startup']
    }
  }
  // ... æ›´å¤šæ¨¡æ¿
]
```

2. **æ¨¡æ¿å›¾ç‰‡å­˜å‚¨**:
```
frontend/public/imgs/nano_banana/
â”œâ”€â”€ business_pro.png
â”œâ”€â”€ tech_future.png
â”œâ”€â”€ education_green.png
â”œâ”€â”€ marketing_orange.png
â””â”€â”€ ... (æ›´å¤šæ¨¡æ¿å›¾ç‰‡)
```

3. **æ¨¡æ¿é€‰æ‹©å™¨ç»„ä»¶**:
```vue
<!-- frontend/src/components/TemplateSelector.vue -->
<template>
  <div class="template-grid">
    <div
      v-for="template in templates"
      :key="template.id"
      class="template-item"
      :class="{ selected: selectedTemplate === template.id }"
      @click="selectTemplate(template.id)"
    >
      <img :src="template.cover" :alt="template.name" />
      <div class="template-info">
        <h4>{{ template.name }}</h4>
        <p>{{ template.description }}</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { NANO_BANANA_TEMPLATES } from '@/configs/nanoBananaTemplates'

const templates = NANO_BANANA_TEMPLATES
const selectedTemplate = defineModel<string>()
</script>
```

**ä¼˜åŠ¿**:
- âœ… æ— éœ€æ•°æ®åº“ï¼Œå¼€å‘æˆæœ¬ä½
- âœ… æ¨¡æ¿æ›´æ–°ç®€å•ï¼Œç›´æ¥æ›¿æ¢å›¾ç‰‡
- âœ… åŠ è½½é€Ÿåº¦å¿«ï¼ŒCDNç¼“å­˜å‹å¥½
- âœ… ä¸ç°æœ‰æ¨¡æ¿ç³»ç»Ÿä¿æŒä¸€è‡´

**æœªæ¥æ‰©å±•**:
- ç”¨æˆ·ä¸Šä¼ æ¨¡æ¿å¯æ‰©å±•ä¸ºæ–‡ä»¶ä¸Šä¼ +æ•°æ®åº“å­˜å‚¨
- çƒ­é—¨æ¨¡æ¿ç»Ÿè®¡å¯æ¥å…¥åŸ‹ç‚¹ç³»ç»Ÿ

#### 2.2.2 ç”Ÿæˆä»»åŠ¡ç¼–æ’æ¨¡å—

**èŒè´£**:
- æ¥æ”¶æ‰¹é‡ç”Ÿæˆè¯·æ±‚
- åˆ†è§£ä¸ºå•é¡µç”Ÿæˆä»»åŠ¡
- ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—å’Œå¹¶å‘æ§åˆ¶
- è·Ÿè¸ªç”ŸæˆçŠ¶æ€

**æ ¸å¿ƒæµç¨‹**:
```python
class BatchGenerationOrchestrator:
    def __init__(self):
        self.task_queue = TaskQueue()
        self.concurrency_limit = 5  # æœ€å¤§å¹¶å‘æ•°
        self.error_handler = ErrorHandler()

    async def generate_slides(self, params: GenerationParams):
        # 1. åˆ›å»ºç”Ÿæˆæ‰¹æ¬¡è®°å½•
        batch_id = await self.create_batch(params)

        # 2. åˆ†è§£ä¸ºå•é¡µä»»åŠ¡
        page_tasks = self.decompose_tasks(params)

        # 3. æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—
        for task in page_tasks:
            await self.task_queue.add(task)

        # 4. å¯åŠ¨å·¥ä½œè¿›ç¨‹
        await self.start_workers(batch_id)

        return batch_id

    async def process_task(self, task: GenerationTask):
        try:
            # ç”Ÿæˆå›¾ç‰‡
            image = await self.generate_page_image(task)

            # ä¸Šä¼ å›¾ç‰‡
            image_url = await self.upload_image(image, task)

            # æ›´æ–°å¹»ç¯ç‰‡
            await self.update_slide(task.slide_id, image_url)

            # ä¸ŠæŠ¥è¿›åº¦
            await self.report_progress(task, 'completed')

        except Exception as e:
            await self.handle_error(task, e)
```

#### 2.2.3 AIæ¨¡å‹é€‚é…å±‚ (æ‰©å±•ç°æœ‰æ¨¡å—)

**è®¾è®¡åŸåˆ™**: å¤ç”¨ç°æœ‰ `backend/app/core/image_generation` åŸºç¡€è®¾æ–½ï¼Œæ–°å¢ NanoBananaProvider ä»¥æ”¯æŒç‰¹å®šé€»è¾‘

**ç°æœ‰æ¶æ„**:
```
backend/app/core/image_generation/
â”œâ”€â”€ base.py                          # BaseImageProvider æŠ½è±¡åŸºç±»
â”œâ”€â”€ config.py                        # æ¨¡å‹é…ç½®
â”œâ”€â”€ factory.py                       # æä¾›å•†å·¥å‚
â””â”€â”€ providers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ openai_compatible.py         # OpenAIå…¼å®¹æä¾›å•†
    â”œâ”€â”€ gemini.py
    â”œâ”€â”€ qwen.py
    â”œâ”€â”€ volcengine_ark.py
    â””â”€â”€ nano_banana.py               # [æ–°å¢] nano banana pro æä¾›å•†
```

**å®ç°æ–¹æ¡ˆ**: åˆ›å»ºç‹¬ç«‹ NanoBananaProvider

```python
# backend/app/core/image_generation/providers/nano_banana.py

from typing import Optional, List, Dict, Any
import aiohttp
from app.core.log_utils import get_logger
from app.core.image_generation.base import BaseImageProvider, ImageGenerationResult

logger = get_logger(__name__)

class NanoBananaProvider(BaseImageProvider):
    """nano banana pro å›¾ç‰‡ç”Ÿæˆæä¾›å•†

    æ”¯æŒOpenAIå…¼å®¹æ¥å£ï¼Œé’ˆå¯¹nano banana proç‰¹æ€§è¿›è¡Œä¼˜åŒ–
    """

    # æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
    SUPPORTED_MODELS = [
        "gemini-3-pro-image-preview",
        "gemini-3-flash-image-preview"
    ]

    # æ”¯æŒçš„å›¾ç‰‡å°ºå¯¸ (16:9 æ¯”ä¾‹ä¸ºä¸»)
    SUPPORTED_SIZES = [
        "1536x1024",   # 16:10
        "1536x864",    # 16:9 (æ¨è)
        "1024x768",    # 4:3
    ]

    # æ”¯æŒçš„è´¨é‡é€‰é¡¹
    SUPPORTED_QUALITIES = ["standard", "hd"]

    def __init__(self, model_config):
        super().__init__(model_config)
        self.api_key = model_config.api_key
        self.base_url = model_config.base_url or "https://api.nanobanana.com/v1"
        self.model = model_config.name

        # éªŒè¯é…ç½®
        if not self.api_key:
            raise ValueError("nano banana API å¯†é’¥æœªé…ç½®")

        if self.model not in self.SUPPORTED_MODELS:
            logger.warning(f"æ¨¡å‹ {self.model} å¯èƒ½ä¸å—æ”¯æŒï¼Œæ”¯æŒçš„æ¨¡å‹: {self.SUPPORTED_MODELS}")

    async def _generate_image_internal(
        self,
        prompt: str,
        size: Optional[str] = None,
        quality: Optional[str] = None,
        ref_image_path: Optional[str] = None,
        additional_ref_images: Optional[List[Union[str, bytes]]] = None,
        **kwargs
    ) -> ImageGenerationResult:
        """å®é™…ç”Ÿæˆå›¾ç‰‡ - nano banana pro å®ç°

        æ”¯æŒä¸»å‚è€ƒå›¾å’Œé¢å¤–å‚è€ƒå›¾çš„ä¼ å…¥ï¼Œé‡‡ç”¨OpenAI Images APIæ ¼å¼
        """

        import aiohttp
        import base64
        from PIL import Image
        from io import BytesIO

        # å‡†å¤‡APIè¯·æ±‚å‚æ•°
        api_params = {
            "model": self.model,
            "prompt": prompt,
            "n": 1,
            "size": size or "1536x864",  # é»˜è®¤16:9
            "quality": quality or "hd",  # é»˜è®¤é«˜è´¨é‡
            "response_format": "b64_json"
        }

        # OpenAI Images APIæ”¯æŒé€šè¿‡messagesä¼ å‚è€ƒå›¾
        messages_content = []

        # æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "X-Provider": "nano-banana"
        }

        try:
            # å¤„ç†å‚è€ƒå›¾ç‰‡
            if ref_image_path or additional_ref_images:
                # æ„å»ºå‚è€ƒå›¾ç‰‡åˆ—è¡¨
                ref_images = []

                # æ·»åŠ ä¸»å‚è€ƒå›¾ç‰‡ï¼ˆå¦‚æœæä¾›äº†è·¯å¾„ï¼‰
                if ref_image_path:
                    if not os.path.exists(ref_image_path):
                        logger.warning(f"å‚è€ƒå›¾ç‰‡ä¸å­˜åœ¨: {ref_image_path}")
                    else:
                        main_ref_image = Image.open(ref_image_path)
                        ref_images.append(main_ref_image)
                        logger.debug(f"åŠ è½½ä¸»å‚è€ƒå›¾: {ref_image_path}")

                # æ·»åŠ é¢å¤–çš„å‚è€ƒå›¾ç‰‡
                if additional_ref_images:
                    for ref_img in additional_ref_images:
                        if isinstance(ref_img, Image.Image):
                            # å·²ç»æ˜¯ PIL Image å¯¹è±¡
                            ref_images.append(ref_img)
                        elif isinstance(ref_img, str):
                            # å¯èƒ½æ˜¯æœ¬åœ°è·¯å¾„
                            if os.path.exists(ref_img):
                                # æœ¬åœ°è·¯å¾„
                                ref_images.append(Image.open(ref_img))
                            elif ref_img.startswith('http://') or ref_img.startswith('https://'):
                                # URLï¼Œéœ€è¦ä¸‹è½½
                                downloaded_img = await self._download_image_from_url(ref_img)
                                if downloaded_img:
                                    ref_images.append(downloaded_img)
                                else:
                                    logger.warning(f"ä¸‹è½½å›¾ç‰‡å¤±è´¥: {ref_img}, è·³è¿‡...")
                            else:
                                logger.warning(f"æ— æ•ˆçš„å›¾ç‰‡å¼•ç”¨: {ref_img}, è·³è¿‡...")
                        else:
                            logger.warning(f"ä¸æ”¯æŒå›¾ç‰‡ç±»å‹: {type(ref_img)}, è·³è¿‡...")

                logger.debug(f"åŠ è½½äº† {len(ref_images)} å¼ å‚è€ƒå›¾ç‰‡")

                # å°†å‚è€ƒå›¾æ·»åŠ åˆ°æ¶ˆæ¯å†…å®¹ä¸­ï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰
                for ref_img in ref_images:
                    # å°†PIL Imageè½¬ä¸ºbase64
                    buffered = BytesIO()
                    if ref_img.mode in ('RGBA', 'LA', 'P'):
                        ref_img = ref_img.convert('RGB')
                    ref_img.save(buffered, format="JPEG", quality=95)
                    img_base64 = base64.b64encode(buffered.getvalue()).decode('utf-8')

                    messages_content.append({
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{img_base64}"
                        }
                    })

            # æ·»åŠ æ–‡æœ¬æç¤ºè¯
            messages_content.append({
                "type": "text",
                "text": prompt
            })

            # æ„å»ºOpenAIæ ¼å¼çš„messages
            messages = [{"role": "user", "content": messages_content}]

            logger.info(
                "è°ƒç”¨nano banana proå›¾ç‰‡ç”ŸæˆAPI",
                extra={
                    "model": api_params["model"],
                    "size": api_params["size"],
                    "quality": api_params["quality"],
                    "ref_images_count": len(messages_content) - 1,
                    "prompt_length": len(prompt)
                }
            )

            # è°ƒç”¨APIï¼ˆä½¿ç”¨Chat Completionsæ ¼å¼ï¼Œæ”¯æŒå›¾ç‰‡è¾“å…¥ï¼‰
            api_payload = {
                "model": self.model,
                "messages": messages,
                "size": size or "1536x864",
                "quality": quality or "hd",
                "n": 1
            }

            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{self.base_url}/chat/completions",
                    headers=headers,
                    json=api_payload,
                    timeout=aiohttp.ClientTimeout(total=120)
                ) as response:

                    if response.status != 200:
                        error_data = await response.text()
                        raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status} - {error_data}")

                    result = await response.json()

                    # ä»å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®
                    # OpenAIè¿”å›æ ¼å¼ä¸­çš„å›¾ç‰‡åœ¨message.contentä¸­
                    message = result.get("choices", [{}])[0].get("message", {})
                    content = message.get("content", [])

                    if isinstance(content, list):
                        # æŸ¥æ‰¾å›¾ç‰‡å†…å®¹
                        image_data = None
                        for item in content:
                            if item.get("type") == "image_url":
                                image_url = item.get("image_url", {}).get("url", "")
                                if image_url.startswith("data:image"):
                                    # ä»data URLä¸­æå–base64æ•°æ®
                                    b64_image = image_url.split(',', 1)[1]
                                    image_data = b64_image
                                    break
                    else:
                        # å…¼å®¹æ—§æ ¼å¼
                        image_data = result.get("data", [{}])[0].get("b64_json") or result.get("data", [{}])[0].get("b64_data")

                    if not image_data:
                        raise Exception("æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®")

                    logger.info("nano banana pro å›¾ç‰‡ç”ŸæˆæˆåŠŸ")

                    # è¿”å›ç»“æœ
                    return ImageGenerationResult(
                        success=True,
                        image_url=f"data:image/png;base64,{image_data}",
                        metadata={
                            "provider": "nano_banana",
                            "model": self.model,
                            "size": size or "1536x864",
                            "quality": quality or "hd",
                            "ref_images_count": len(messages_content) - 1
                        }
                    )

        except Exception as e:
            logger.error(
                f"nano banana pro å›¾ç‰‡ç”Ÿæˆå¤±è´¥: {str(e)}",
                exc_info=True,
                extra={"model": self.model}
            )

            return ImageGenerationResult(
                success=False,
                error_message=str(e),
                metadata={
                    "provider": "nano_banana",
                    "model": self.model
                }
            )

    def supports_model(self, model_name: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦æ”¯æŒæŒ‡å®šæ¨¡å‹"""
        return model_name in self.SUPPORTED_MODELS

    def get_supported_models(self) -> List[str]:
        """è·å–æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨"""
        return self.SUPPORTED_MODELS

    def get_supported_sizes(self) -> List[str]:
        """è·å–æ”¯æŒçš„å›¾ç‰‡å°ºå¯¸åˆ—è¡¨"""
        return self.SUPPORTED_SIZES

    def get_supported_qualities(self) -> List[str]:
        """è·å–æ”¯æŒçš„å›¾ç‰‡è´¨é‡åˆ—è¡¨"""
        return self.SUPPORTED_QUALITIES
```

**æ›´æ–°å·¥å‚å‡½æ•°**:

```python
# backend/app/core/image_generation/factory.py

from .providers.nano_banana import NanoBananaProvider

def get_image_provider(model_config):
    """è·å–å›¾ç‰‡ç”Ÿæˆæä¾›å•†"""
    provider_type = getattr(model_config, 'provider_type', 'openai_compatible')

    if provider_type == "nano_banana":
        return NanoBananaProvider(model_config)
    elif provider_type == "openai_compatible":
        return OpenAICompatibleProvider(model_config)
    elif provider_type == "gemini":
        return GeminiProvider(model_config)
    elif provider_type == "qwen":
        return QwenProvider(model_config)
    elif provider_type == "volcengine_ark":
        return VolcengineArkProvider(model_config)
    else:
        raise ValueError(f"ä¸æ”¯æŒçš„æä¾›å•†ç±»å‹: {provider_type}")
```

**é…ç½®ç¤ºä¾‹**:

**åœ¨ä¸šåŠ¡æœåŠ¡ä¸­ä½¿ç”¨**:

```python
# backend/app/services/nano_banana/batch_generation_service.py

from app.core.image_generation.factory import get_image_provider
from app.repositories.ai_model import AIModelRepository

class BatchGenerationService:
    """æ‰¹é‡ç”ŸæˆæœåŠ¡"""

    def __init__(self, db: AsyncSession):
        self.db = db
        self.model_repository = AIModelRepository(db)

    async def _get_nano_banana_provider(self):
        """è·å– nano banana æä¾›å•†"""

        # ä»æ•°æ®åº“æŸ¥è¯¢å¯ç”¨çš„å›¾ç‰‡ç”Ÿæˆæ¨¡å‹
        models = await self.model_repository.list_models(
            enabled_only=True,
            supports_image_generation=True
        )

        # æ‰¾åˆ° nano banana æ¨¡å‹ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼‰
        nano_banana_model = next(
            (m for m in models if m.provider_type == 'nano_banana'),
            models[0] if models else None
        )

        if not nano_banana_model:
            raise ValueError("æœªé…ç½®å¯ç”¨çš„å›¾ç‰‡ç”Ÿæˆæ¨¡å‹")

        # æ„å»ºæ¨¡å‹é…ç½®
        model_config = type('ModelConfig', (), {
            'provider_type': 'nano_banana',
            'api_key': nano_banana_model.get_decrypted_key(),
            'base_url': nano_banana_model.config.get('base_url'),
            'name': nano_banana_model.ai_model_name,
            'timeout': nano_banana_model.config.get('timeout', 120),
            'max_retries': nano_banana_model.config.get('max_retries', 2)
        })()

        # é€šè¿‡å·¥å‚è·å–æä¾›å•†å®ä¾‹
        return get_image_provider(model_config)

    async def generate_single_slide(self, task: GenerationTask):
        """ç”Ÿæˆå•é¡µå¹»ç¯ç‰‡"""

        # è°ƒç”¨å›¾ç‰‡ç”Ÿæˆï¼Œè‡ªåŠ¨è·å¾— MLflow è¿½è¸ª
        result = await self.image_provider.generate_image(
            prompt=task.prompt,
            size=task.image_size or "1536x864",
            quality=task.quality or "hd"
        )

        if result.success:
            # ä¸Šä¼ åˆ° COS
            image_url = await self.upload_to_cos(result.image_url, task)
            return image_url
        else:
            raise GenerationError(result.error_message)
```

**ä¼˜åŠ¿**:
- âœ… ç‹¬ç«‹å®ç°ï¼Œæ¸…æ™°è¡¨è¾¾ nano banana pro çš„ç‰¹å®šé€»è¾‘
- âœ… ç»§æ‰¿ç°æœ‰åŸºç¡€è®¾æ–½ï¼ˆMLflowè¿½è¸ªã€é”™è¯¯å¤„ç†ã€æ—¥å¿—ï¼‰
- âœ… æ”¯æŒ nano banana ç‰¹æœ‰çš„å‚æ•°å’ŒåŠŸèƒ½
- âœ… ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ˜“äºæ‰©å±•
- âœ… é¿å…é‡å¤ä»£ç ï¼Œå¤ç”¨æŠ½è±¡åŸºç±»

**MLflow è¿½è¸ªé›†æˆ**:
è‡ªåŠ¨ç»§æ‰¿ BaseImageProvider çš„ MLflow è¿½è¸ªåŠŸèƒ½ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š
- æ¨¡å‹è°ƒç”¨å‚æ•°è®°å½•
- å“åº”æ—¶é—´ç»Ÿè®¡
- æˆåŠŸç‡/å¤±è´¥ç‡
- é”™è¯¯è¿½è¸ª
- æ‰§è¡Œé“¾è·¯è¿½è¸ª

#### 2.2.4 è¿›åº¦ç®¡ç†æ¨¡å— (Demoé˜¶æ®µç®€åŒ–å®ç°)

**å®ç°æ–¹æ¡ˆ**: **HTTP è½®è¯¢** (Simple Polling)

**é€‰æ‹©è½®è¯¢çš„åŸå› **:
- âœ… å®ç°ç®€å•ï¼Œå‰ç«¯åç«¯éƒ½å®¹æ˜“å®ç°
- âœ… æ— éœ€é¢å¤–ä¾èµ–ï¼ˆWebSocketéœ€è¦ç»´æŠ¤é•¿è¿æ¥ï¼‰
- âœ… å…¼å®¹æ€§å¥½ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ
- âœ… è¶³å¤Ÿæ»¡è¶³ Demo é˜¶æ®µéœ€æ±‚

**è½®è¯¢å·¥ä½œåŸç†**:

```
æ—¶é—´çº¿:
0s          5s          10s         15s         20s
|           |           |           |           |
å®¢æˆ·ç«¯: å‘èµ·è¯·æ±‚ â†’ è·å–è¿›åº¦(15%) â†’ è·å–è¿›åº¦(30%) â†’ è·å–è¿›åº¦(45%) â†’ å®Œæˆ
æœåŠ¡å™¨: æŸ¥è¯¢çŠ¶æ€ â†’ è¿”å›15%    â†’ è¿”å›30%    â†’ è¿”å›45%    â†’ è¿”å›100%
```

**Demoé˜¶æ®µçš„ç®€å•å®ç°**:

```python
# åç«¯ API - æŸ¥è¯¢è¿›åº¦
@app.get("/api/v1/slide-generations/batches/{batch_id}/progress")
async def get_generation_progress(batch_id: str):
    """æŸ¥è¯¢ç”Ÿæˆè¿›åº¦ (è½®è¯¢æ¥å£)"""

    # ä» Redis æˆ–æ•°æ®åº“æŸ¥è¯¢è¿›åº¦
    progress = await progress_manager.get_progress(batch_id)

    return {
        "batch_id": batch_id,
        "status": progress.status,
        "progress": {
            "current_page": progress.current,
            "total_pages": progress.total,
            "completed_pages": progress.completed,
            "failed_pages": progress.failed,
            "percentage": (progress.completed / progress.total) * 100
        },
        "results": progress.results,
        "estimated_remaining_time": progress.eta
    }
```

```javascript
// å‰ç«¯ - è½®è¯¢å®ç°
async function pollProgress(batchId, interval = 2000) {
  const poll = async () => {
    try {
      const response = await fetch(
        `/api/v1/slide-generations/batches/${batchId}/progress`
      );
      const data = await response.json();

      // æ›´æ–°UI
      updateProgressBar(data.progress.percentage);
      updateThumbnails(data.results);

      // æ£€æŸ¥æ˜¯å¦å®Œæˆ
      if (data.status === 'completed' || data.status === 'failed') {
        clearInterval(timer);
        handleCompletion(data);
        return;
      }
    } catch (error) {
      console.error('è½®è¯¢å¤±è´¥:', error);
      clearInterval(timer);
    }
  };

  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  await poll();

  // å®šæ—¶è½®è¯¢
  const timer = setInterval(poll, interval);

  return timer;
}

// ä½¿ç”¨ç¤ºä¾‹
const timer = pollProgress('batch_123', 2000);  // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡

// é¡µé¢å¸è½½æ—¶æ¸…ç†
cleanup = () => {
  if (timer) clearInterval(timer);
};
```

**è½®è¯¢å‚æ•°å»ºè®®**:
- **é—´éš”æ—¶é—´**: 2-3ç§’ï¼ˆå¹³è¡¡å®æ—¶æ€§å’ŒæœåŠ¡å™¨å‹åŠ›ï¼‰
- **è¶…æ—¶è®¾ç½®**: å•æ¬¡è¯·æ±‚è¶…æ—¶10ç§’
- **é‡è¯•æ¬¡æ•°**: å¤±è´¥é‡è¯•3æ¬¡
- **è½®è¯¢åœæ­¢æ¡ä»¶**: çŠ¶æ€ä¸º completed/failed æˆ–ç”¨æˆ·æ‰‹åŠ¨å–æ¶ˆ

**Demoé˜¶æ®µä¼˜åŠ¿**:
- âœ… ä»£ç ç®€å•ï¼Œ1å°æ—¶å³å¯å®ç°
- âœ… æ— éœ€å­¦ä¹ WebSocket API
- âœ… è°ƒè¯•æ–¹ä¾¿ï¼Œå¯ç›´æ¥ç”¨æµè§ˆå™¨è®¿é—®æµ‹è¯•
- âœ… æ— è¿æ¥ç®¡ç†é—®é¢˜ï¼ˆæ–­çº¿ã€é‡è¿ï¼‰
- âœ… æœåŠ¡å™¨èµ„æºå ç”¨å°‘

## 3. æ•°æ®ç»“æ„è®¾è®¡

### 3.1 å½“å‰å®ç°çš„æ•°æ®æµè½¬

åŸºäºç°æœ‰çš„æµå¼ç”Ÿæˆæ¶æ„ï¼Œæ•°æ®æµè½¬ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

#### 3.1.1 å¤§çº²ç”Ÿæˆé˜¶æ®µ

```
å‰ç«¯è¯·æ±‚
  â†“ POST /api/v1/generate/outline
  â†“ {
  â†“   "topic": "æœ‰ç†æ•°æ¯”è¾ƒ",
  â†“   "content": "ã€Šä¸ƒå¹´çº§ä¸Š...ã€‹"
  â†“ }
  â†“
åç«¯å¤„ç†
  â†“
æµå¼è¿”å›å¤§çº²æ•°æ®
  â†“ data: {"status": "generating"}
  â†“ data: {"outline": "1. æƒ…å¢ƒå¼•å…¥..."}
  â†“ data: {"status": "complete", "outline": "å®Œæ•´å¤§çº²å†…å®¹"}
  â†“
å‰ç«¯æš‚å­˜ (ä¸å­˜æ•°æ®åº“)
  â†“ å­˜å‚¨åœ¨ç»„ä»¶çŠ¶æ€æˆ–Pinia Storeä¸­
  â†“
ç”¨æˆ·ç¼–è¾‘å¤§çº²
  â†“ åœ¨å‰ç«¯ç›´æ¥ä¿®æ”¹å¤§çº²å†…å®¹
  â†“
è°ƒç”¨slidesç”Ÿæˆ
  â†“ POST /api/v1/generate/slides
  â†“ {
  â†“   "outline": "ç¼–è¾‘åçš„å¤§çº²å†…å®¹",
  â†“   "language": "ä¸­æ–‡",
  â†“   "style": "é€šç”¨"
  â†“ }
```

#### 3.1.2 å¹»ç¯ç‰‡ç”Ÿæˆé˜¶æ®µï¼ˆæµå¼è¾“å‡ºï¼‰

```
å‰ç«¯è¯·æ±‚ /api/v1/generate/slides
  â†“
åç«¯æ¥æ”¶å¤§çº²å†…å®¹
  â†“
é€é¡µè°ƒç”¨AIç”Ÿæˆ
  â†“ æ¯é¡µç”Ÿæˆåé€šè¿‡SSEè¿”å›
  â†“
æµå¼å“åº”æ ¼å¼:
  â”œâ”€ data: {"event": "start", "data": {...}}
  â”œâ”€ data: {"type": "cover", "data": {...}}
  â”œâ”€ data: {"type": "contents", "data": {...}}
  â”œâ”€ data: {"type": "transition", "data": {...}}
  â”œâ”€ data: {"type": "content", "data": {...}}
  â””â”€ data: {"event": "complete", "data": {...}}
```

### 3.2 æ•°æ®æ¨¡å‹è¯´æ˜

#### 3.2.1 ä¸ºä»€ä¹ˆä¸éœ€è¦é¢å¤–çš„æ•°æ®åº“è¡¨

åœ¨DemoéªŒè¯é˜¶æ®µï¼Œé‡‡ç”¨è½»é‡çº§å®ç°ç­–ç•¥ï¼š

1. **æ— å¤§çº²å­˜å‚¨**
   - å¤§çº²åªåœ¨å‰ç«¯ä¸´æ—¶å­˜å‚¨
   - ç”¨æˆ·ç¼–è¾‘åç›´æ¥å‘é€åˆ°slidesç”Ÿæˆæ¥å£
   - æ— éœ€æŒä¹…åŒ–ï¼ˆç®€åŒ–å®ç°ã€å¿«é€ŸéªŒè¯ï¼‰

2. **æ— æ‰¹æ¬¡ç®¡ç†**
   - ä¸€æ¬¡slidesè¯·æ±‚å³ä¸€ä¸ªå®Œæ•´æ‰¹æ¬¡
   - çŠ¶æ€ç®¡ç†åœ¨å‰ç«¯é€šè¿‡SSEäº‹ä»¶å®Œæˆ
   - æ— éœ€åç«¯æ‰¹æ¬¡çŠ¶æ€è¿½è¸ª

3. **æ— æ¨¡æ¿è¡¨**
   - æ¨¡æ¿é…ç½®åœ¨å‰ç«¯é™æ€é…ç½®æ–‡ä»¶ä¸­
   - é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†æ¨¡æ¿åˆ—è¡¨
   - æ— éœ€æ•°æ®åº“æ”¯æŒï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰

4. **æµå¼è¾“å‡ºä¸­é—´çŠ¶æ€ä¸å­˜å‚¨**
   - partial_content åªåœ¨ç”Ÿæˆæµä¸­ä¸´æ—¶ä½¿ç”¨
   - æœ€ç»ˆå®Œæ•´å†…å®¹è¿”å›ç»™å‰ç«¯åæµç»“æŸ
   - æ— éœ€é¢å¤–çš„slidesè¡¨å­˜å‚¨ä¸­é—´ç»“æœ

#### 3.2.2 æœªæ¥æ¼”è¿›æ–¹å‘

å½“éœ€è¦æ”¯æŒä»¥ä¸‹åœºæ™¯æ—¶ï¼Œå†å¼•å…¥æ•°æ®åº“è¡¨ï¼š

- **å†å²è®°å½•æŸ¥è¯¢** â†’ éœ€è¦ slides å†å²è¡¨
- **æ–­ç‚¹ç»­ä¼ ** â†’ éœ€è¦æ‰¹æ¬¡çŠ¶æ€è¡¨
- **å¤šäººåä½œ** â†’ éœ€è¦å¤§çº²ç‰ˆæœ¬ç®¡ç†
- **æ¨¡æ¿å¸‚åœº** â†’ éœ€è¦æ¨¡æ¿è¡¨

### 3.3 æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆä»£ç å±‚é¢ï¼‰

#### 3.3.1 å¤§çº²æ•°æ®ç»“æ„

```python
@dataclass
class OutlineData:
    """å¤§çº²æ•°æ®ç»“æ„"""
    topic: str                    # ä¸»é¢˜
    content: str                  # å‰¯æ ‡é¢˜/å†…å®¹æè¿°
    outline: str                  # ç”Ÿæˆçš„å¤§çº²å†…å®¹ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
    language: str = "ä¸­æ–‡"        # è¯­è¨€
    style: str = "é€šç”¨"           # é£æ ¼
```

#### 3.3.2 å¹»ç¯ç‰‡è¿”å›æ•°æ®ç»“æ„

```python
@dataclass
class SlideEvent:
    """SSEäº‹ä»¶æ•°æ®ç»“æ„"""

    # äº‹ä»¶ç±»å‹ï¼šstart, cover, contents, transition, content, complete
    event: str

    # äº‹ä»¶æ•°æ®
    data: Dict[str, Any]

    # ä¸åŒäº‹ä»¶çš„dataç»“æ„ç¤ºä¾‹ï¼š
    # start: {"content_length", "language", "style", "mock_mode", "timestamp"}
    # cover: {"title", "text"}
    # contents: {"items": [...]}
    # transition: {"title", "text"}
    # content: {"title", "semanticFeatures", "items": [...]}
    # complete: {"total_slides", "generation_time", "operation_type"}
```

#### 3.3.3 å†…å®¹é¡¹æ•°æ®ç»“æ„

```python
@dataclass
class ContentItem:
    """å†…å®¹é¡¹æ•°æ®ç»“æ„"""
    title: str                    # æ ‡é¢˜
    text: str                     # å†…å®¹æ–‡æœ¬
    metadata: Dict[str, Any] = None  # å…ƒæ•°æ®ï¼ˆåˆ†ç±»ã€æ­¥éª¤ç­‰ï¼‰
```

#### 3.3.4 è¯­ä¹‰ç‰¹å¾ç»“æ„

```python
@dataclass
class SemanticFeatures:
    """è¯­ä¹‰ç‰¹å¾ç”¨äºæŒ‡å¯¼å¸ƒå±€å’Œç”Ÿæˆ"""
    logicType: str               # é€»è¾‘ç±»å‹ï¼šsequential, classification, hierarchical, comparison, problem_solution
    contentType: str             # å†…å®¹ç±»å‹ï¼šlesson_introduction, concept_explanation, comparison_analysis, problem_discussion
    phase: Optional[str] = None  # é˜¶æ®µï¼šcreative_thinkingç­‰
```

## 4. æ ¸å¿ƒå®ç°æµç¨‹

### 4.1 ç”Ÿæˆæµç¨‹å›¾ï¼ˆåŸºäºå½“å‰æµå¼å®ç°ï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant Backend as åç«¯æœåŠ¡
    participant AI as AIæ¨¡å‹

    %% å¤§çº²ç”Ÿæˆé˜¶æ®µ
    User->>Frontend: è¾“å…¥ä¸»é¢˜å’Œå‰¯æ ‡é¢˜
    Frontend->>Backend: POST /api/v1/generate/outline
    Backend->>AI: æ„å»ºå¤§çº²ç”Ÿæˆprompt
    loop æµå¼è¿”å›
        AI-->>Backend: éƒ¨åˆ†å¤§çº²å†…å®¹
        Backend-->>Frontend: SSE: data: {"outline": "..."}
    end
    Frontend->>User: æ˜¾ç¤ºå¤§çº²ï¼ˆå¯ç¼–è¾‘ï¼‰
    User->>Frontend: ç¼–è¾‘å¤§çº²å†…å®¹

    %% å¹»ç¯ç‰‡ç”Ÿæˆé˜¶æ®µï¼ˆæµå¼è¾“å‡ºï¼‰
    User->>Frontend: ç‚¹å‡»"ç”Ÿæˆå¹»ç¯ç‰‡"
    Frontend->>Backend: POST /api/v1/generate/slides<br/>{"outline": "ç¼–è¾‘åå†…å®¹"}
    Backend->>Backend: è§£æå¤§çº²ä¸ºç« èŠ‚ç»“æ„
    loop æ¯é¡µç”Ÿæˆ
        Backend->>AI: è°ƒç”¨AIç”Ÿæˆå•é¡µ
        AI-->>Backend: è¿”å›å•é¡µJSONæ•°æ®
        Backend-->>Frontend: SSE: data: {"type": "content", "data": {...}}
        Frontend->>Frontend: å®æ—¶æ¸²æŸ“è¯¥é¡µ
    end
    Backend-->>Frontend: SSE: data: {"event": "complete", ...}
    Frontend->>User: æ˜¾ç¤º"ç”Ÿæˆå®Œæˆ"
```

### 4.2 è¯¦ç»†æµç¨‹è¯´æ˜

#### 4.2.1 å¤§çº²ç”Ÿæˆæµç¨‹

**å‰ç«¯è¯·æ±‚**ï¼š
```javascript
// è¯·æ±‚ç¤ºä¾‹
const response = await fetch('/api/v1/generate/outline', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    topic: 'æœ‰ç†æ•°æ¯”è¾ƒ',
    content: 'ã€Šä¸ƒå¹´çº§ä¸ŠÂ·ç¬¬ä¸€ç«  æœ‰ç†æ•°Â·æŠ€æœ¯æ€ç»´æ¨¡å—ã€‹'
  })
})
```

**åç«¯å¤„ç†**ï¼š
```python
# ä¸»è¦é€»è¾‘ï¼ˆç®€åŒ–ï¼‰
async def generate_outline(request):
    # 1. æ¥æ”¶å‚æ•°
    topic = request.topic
    content = request.content

    # 2. æ„å»ºprompt
    prompt = f"""
    è¯·ä¸ºä»¥ä¸‹ä¸»é¢˜ç”ŸæˆPPTå¤§çº²ï¼š
    ä¸»é¢˜ï¼š{topic}
    å†…å®¹ï¼š{content}

    è¦æ±‚ï¼š
    - ç”Ÿæˆ8-12é¡µçš„è¯¦ç»†å¤§çº²
    - åŒ…å«å°é¢ã€ç›®å½•ã€è¿‡æ¸¡é¡µã€å†…å®¹é¡µã€ç»“æŸé¡µ
    - æŒ‰ç…§æ•™å­¦é€»è¾‘ç»„ç»‡
    """

    # 3. è°ƒç”¨AIç”Ÿæˆ
    async for chunk in ai_client.stream_generate(prompt):
        yield f"data: {json.dumps({'outline': chunk})}\\n\\n"

    # 4. å‘é€å®Œæˆäº‹ä»¶
    yield 'data: {"status": "complete"}\\n\\n'
```

**å‰ç«¯å¤„ç†æµå¼å“åº”**ï¼š
```javascript
const reader = response.body.getReader()
const decoder = new TextDecoder()

while (true) {
  const { done, value } = await reader.read()
  if (done) break

  const chunk = decoder.decode(value)
  const lines = chunk.split('\\n')

  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = JSON.parse(line.slice(6))

      if (data.status === 'complete') {
        // ç”Ÿæˆå®Œæˆ
        break
      } else if (data.outline) {
        // ç´¯åŠ å¤§çº²å†…å®¹
        outline.value += data.outline
      }
    }
  }
}
```

#### 4.2.2 å¹»ç¯ç‰‡ç”Ÿæˆæµç¨‹ï¼ˆæ ¸å¿ƒï¼‰

**å‰ç«¯è¯·æ±‚**ï¼š
```javascript
// å‘é€ç”Ÿæˆè¯·æ±‚
const response = await fetch('/api/v1/generate/slides', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    outline: outline.value,      // ç¼–è¾‘åçš„å¤§çº²
    language: 'ä¸­æ–‡',
    style: 'é€šç”¨',
    mock_mode: true              // å¯é€‰ï¼šmockæ¨¡å¼
  })
})
```

**åç«¯æµå¼å¤„ç†**ï¼š
```python
# ç®€åŒ–çš„æµå¼å¤„ç†é€»è¾‘
async def generate_slides_stream(request):
    outline = request.outline

    # 1. å‘é€å¼€å§‹äº‹ä»¶
    yield f"data: {json.dumps({
        'event': 'start',
        'data': {
            'content_length': len(outline),
            'language': request.language,
            'style': request.style,
            'mock_mode': request.mock_mode,
            'timestamp': time.time(),
            'operation_type': 'slides_generation'
        }
    })}\\n\\n"

    # 2. è§£æå¤§çº²ä¸ºç« èŠ‚
    sections = parse_outline_to_sections(outline)

    # 3. é€é¡µç”Ÿæˆ
    for idx, section in enumerate(sections):
        if request.mock_mode:
            # Mockæ¨¡å¼ï¼šç›´æ¥è¿”å›å›ºå®šæ ¼å¼
            slide_data = generate_mock_slide(section, idx)
        else:
            # çœŸå®æ¨¡å¼ï¼šè°ƒç”¨AI
            slide_data = await generate_slide_with_ai(section, idx)

        # å‘é€è¯¥é¡µæ•°æ®
        yield f"data: {json.dumps(slide_data)}\\n\\n"

    # 4. å‘é€å®Œæˆäº‹ä»¶
    yield f"data: {json.dumps({
        'event': 'complete',
        'data': {
            'total_slides': len(sections),
            'generation_time': time.time() - start_time,
            'mock_mode': request.mock_mode
        }
    })}\\n\\n"
```

**æµå¼å“åº”æ ¼å¼è¯´æ˜**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®ç»“æ„ |
|---------|------|---------|
| `start` | ç”Ÿæˆå¼€å§‹ | `{content_length, language, style, mock_mode}` |
| `prompt_ready` | Promptå‡†å¤‡å°±ç»ª | `{system_prompt_length, user_prompt_length}` |
| `cover` | å°é¢é¡µ | `{title, text}` |
| `contents` | ç›®å½•é¡µ | `{items: [...]}` |
| `transition` | è¿‡æ¸¡é¡µ | `{title, text}` |
| `content` | å†…å®¹é¡µ | `{title, semanticFeatures, items: [...]}` |
| `complete` | å®Œæˆäº‹ä»¶ | `{total_slides, generation_time}` |

#### 4.2.3 å‰ç«¯å®æ—¶æ¸²æŸ“æµç¨‹

```javascript
import { useSlidesStore } from '@/store/slides'

// æµå¼æ¥æ”¶å¹¶å®æ—¶æ¸²æŸ“
async function streamGenerateSlides() {
  const store = useSlidesStore()
  const response = await fetch('/api/v1/generate/slides', {
    method: 'POST',
    body: JSON.stringify({ outline: outline.value })
  })

  const reader = response.body.getReader()
  const decoder = new TextDecoder()

  while (true) {
    const { done, value } = await reader.read()
    if (done) break

    const lines = decoder.decode(value).split('\n')
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue

      const event = JSON.parse(line.slice(6))

      // æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
      switch (event.event || event.type) {
        case 'start':
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          store.setGenerating(true)
          break

        case 'cover':
        case 'contents':
        case 'transition':
        case 'content':
          // æ·»åŠ åˆ°å¹»ç¯ç‰‡åˆ—è¡¨ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
          store.addSlide({
            type: event.type,
            data: event.data
          })
          break

        case 'complete':
          // ç”Ÿæˆå®Œæˆ
          store.setGenerating(false)
          store.setComplete(true)
          break
      }
    }
  }
}
```

### 4.3 å‰ç«¯æ•°æ®ç»“æ„ç¤ºä¾‹

å‰ç«¯æ¥æ”¶åˆ°çš„å®Œæ•´å¹»ç¯ç‰‡æ•°æ®ç»“æ„ï¼š

```typescript
interface SlideData {
  type: 'cover' | 'contents' | 'transition' | 'content'
  data: {
    // é€šç”¨å­—æ®µ
    title?: string
    text?: string

    // contentç±»å‹ç‰¹æœ‰
    semanticFeatures?: {
      logicType: 'sequential' | 'classification' | 'hierarchical'
      contentType: 'lesson_introduction' | 'concept_explanation'
    }
    items?: Array<{
      title: string
      text: string
      metadata?: Record<string, any>
    }>
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const slides: SlideData[] = [
  {
    type: 'cover',
    data: {
      title: 'æ„æ€æ¯”è¾ƒçš„"ç›´æ¥"æ³•åˆ™',
      text: 'ã€Šä¸ƒå¹´çº§ä¸ŠÂ·ç¬¬ä¸€ç«  æœ‰ç†æ•°Â·æŠ€æœ¯æ€ç»´æ¨¡å—ã€‹'
    }
  },
  {
    type: 'contents',
    data: {
      items: [
        'æƒ…å¢ƒå¼•å…¥ï¼šå¿ƒç®—æŒ‘æˆ˜',
        'æ¢ç©¶å»ºæ„ï¼šåˆ†ç±»ä¸æ¯”è¾ƒ',
        'æŠ€æœ¯æ–¹æ¡ˆï¼šç›´æ¥æ³•åˆ™',
        'æµ‹è¯„éªŒè¯ï¼šåŸºç¡€ä¸åº”ç”¨',
        'æ€è€ƒè¡¨è¾¾ï¼šåˆ›æ–°ä¸åº”ç”¨'
      ]
    }
  }
]
```

## 4. æ ¸å¿ƒå®ç°æµç¨‹

### 4.1 ç”Ÿæˆæµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as å‰ç«¯UI
    participant API as APIç½‘å…³
    participant Orchestrator as ä»»åŠ¡ç¼–æ’å™¨
    participant Queue as ä»»åŠ¡é˜Ÿåˆ—
    participant Worker as å·¥ä½œè¿›ç¨‹
    participant Provider as AIæ¨¡å‹
    participant Storage as äº‘å­˜å‚¨

    User->>UI: ç‚¹å‡»"é¦™è•‰ç”Ÿæˆ"
    UI->>UI: æ‰“å¼€æ¨¡æ¿é€‰æ‹©å™¨
    User->>UI: é€‰æ‹©æ¨¡æ¿
    User->>UI: ç‚¹å‡»"è‡ªåŠ¨ç”Ÿæˆ"
    UI->>API: POST /api/v1/batch-generation
    API->>Orchestrator: create_batch_generation(params)
    Orchestrator->>Orchestrator: parse_outline_pages()
    Orchestrator->>Orchestrator: create_tasks()
    Orchestrator->>Queue: add_tasks(tasks)
    API-->>UI: è¿”å› batch_id

    loop å¹¶è¡Œç”Ÿæˆ (max 5å¹¶å‘)
        Queue->>Worker: è·å–ä»»åŠ¡
        Worker->>Provider: generate_image(prompt, template)
        Provider-->>Worker: è¿”å›å›¾ç‰‡
        Worker->>Storage: ä¸Šä¼ å›¾ç‰‡
        Worker->>Orchestrator: report_progress()
        Orchestrator->>UI: WebSocketæ¨é€è¿›åº¦
    end

    Orchestrator->>Orchestrator: check_completion()
    Orchestrator->>UI: æ¨é€å®Œæˆé€šçŸ¥
    UI->>User: æ˜¾ç¤º"ç”Ÿæˆå®Œæˆ"
```

### 4.2 è¯¦ç»†æµç¨‹è¯´æ˜ï¼ˆä»¥ç”Ÿæˆ4å¼ å¹»ç¯ç‰‡ä¸ºä¾‹ï¼‰

#### 4.2.1 è¯·æ±‚é˜¶æ®µ (0-2ç§’)

**å‰ç«¯æ“ä½œ**:
1. **ç”¨æˆ·åœ¨å¤§çº²é¡µé¢ç‚¹å‡»"é¦™è•‰ç”Ÿæˆ"æŒ‰é’®**
2. **å¼¹å‡ºæ¨¡æ¿é€‰æ‹©å¯¹è¯æ¡†**
   - å±•ç¤º8-12ä¸ªé¢„è®¾æ¨¡æ¿å›¾ç‰‡ç½‘æ ¼
   - ç”¨æˆ·ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿ï¼ˆä¾‹å¦‚ï¼š"ä¸“ä¸šå•†åŠ¡é£"ï¼‰
3. **ç‚¹å‡»"è‡ªåŠ¨ç”Ÿæˆ"æŒ‰é’®**
4. **å‰ç«¯æ”¶é›†å‚æ•°**
   ```javascript
   // å‰ç«¯å‘é€çš„è¯·æ±‚å‚æ•°
   {
     "outline_id": "outline_123",           // å¤§çº²ID
     "template_id": "nano_banana_1",        // é€‰æ‹©çš„æ¨¡æ¿
     "options": {
       "resolution": "1536x864",            // 16:9 æ¯”ä¾‹
       "quality": "hd"                       // é«˜è´¨é‡
     }
   }
   ```
5. **æ˜¾ç¤ºè¿›åº¦æµ®çª—å¹¶å¯åŠ¨è½®è¯¢**

**åç«¯å¤„ç†**:
1. **æ¥æ”¶æ‰¹é‡ç”Ÿæˆè¯·æ±‚**
   ```python
   POST /api/v1/slide-generations/batches
   ```
2. **ç³»ç»ŸéªŒè¯**
   - éªŒè¯ outline_id æ˜¯å¦å­˜åœ¨
   - éªŒè¯ template_id æ˜¯å¦æœ‰æ•ˆ
   - éªŒè¯ç”¨æˆ·æƒé™ï¼ˆæ˜¯å¦æœ‰è¶³å¤ŸAPIè°ƒç”¨é¢åº¦ï¼‰
3. **åˆ›å»ºæ‰¹æ¬¡è®°å½•**
   ```python
   batch_id = "batch_20241220_001"
   status = "pending"
   total_pages = 4  // æ ¹æ®å¤§çº²è§£æå¾—åˆ°
   ```
4. **è¿”å›æ‰¹æ¬¡ID**
   ```json
   {
     "batch_id": "batch_20241220_001",
     "status": "pending",
     "total_pages": 4,
     "estimated_time": 30
   }
   ```

#### 4.2.2 åˆå§‹åŒ–é˜¶æ®µ (2-5ç§’)

**åç«¯å¤„ç†**:
1. **å¤§çº²è§£æ** (è€—æ—¶2-3ç§’)
   ```python
   # ä»æ•°æ®åº“è·å–å¤§çº²å†…å®¹
   outline = await db.get_outline(outline_id)

   # AIè§£æå¤§çº²ä¸º4ä¸ªé¡µé¢ç»“æ„
   pages = await ai_service.parse_outline_to_pages(outline)
   # è¿”å›ç»“æœç¤ºä¾‹:
   [
     {"page_number": 1, "title": "å°é¢", "content": "..."},
     {"page_number": 2, "title": "é—®é¢˜åˆ†æ", "content": "..."},
     {"page_number": 3, "title": "è§£å†³æ–¹æ¡ˆ", "content": "..."},
     {"page_number": 4, "title": "æ€»ç»“", "content": "..."}
   ]
   ```
2. **åˆ›å»ºç”Ÿæˆä»»åŠ¡** (è€—æ—¶0.5ç§’)
   ```python
   # ä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºä»»åŠ¡
   tasks = []
   for page in pages:
       task = {
           "batch_id": "batch_20241220_001",
           "page_number": page["page_number"],
           "slide_id": f"slide_{page['page_number']}",
           "prompt": build_image_prompt(page, template),  // æ„å»ºå›¾ç‰‡ç”Ÿæˆæç¤ºè¯
           "status": "pending",
           "retry_count": 0
       }
       tasks.append(task)
   ```
3. **æäº¤åˆ°Redisé˜Ÿåˆ—** (è€—æ—¶0.1ç§’)
   ```python
   for task in tasks:
       await redis.lpush("generation_queue", task.to_json())
   ```
4. **æ›´æ–°æ‰¹æ¬¡çŠ¶æ€ä¸º "generating"**

#### 4.2.3 ç”Ÿæˆé˜¶æ®µ (5-60ç§’) - æ ¸å¿ƒæµç¨‹

**åç«¯å¹¶è¡Œç”Ÿæˆ**:

```python
# Workerè¿›ç¨‹å¹¶è¡Œå¤„ç†ï¼ˆæœ€å¤š5ä¸ªå¹¶å‘ï¼‰
class GenerationWorker:
    async def process_task(self, task):
        # 1. è·å–ä»»åŠ¡
        task = await redis.brpop("generation_queue")

        # 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º "generating"
        await db.update_task_status(task.id, "generating")

        # 3. è°ƒç”¨nano banana APIç”Ÿæˆå›¾ç‰‡
        try:
            # æ„å»ºè°ƒç”¨å‚æ•°
            prompt = task.prompt
            ref_image = load_template_image(task.template_id)  // åŠ è½½æ¨¡æ¿ä½œä¸ºå‚è€ƒå›¾

            # è°ƒç”¨NanoBananaProvider
            result = await nano_banana_provider.generate_image(
                prompt=prompt,
                ref_image_path=ref_image,        // ä¸»å‚è€ƒå›¾ï¼ˆæ¨¡æ¿ï¼‰
                additional_ref_images=None,     // é¢å¤–å‚è€ƒå›¾ï¼ˆå¯é€‰ï¼‰
                aspect_ratio="16:9",
                resolution="2K"
            )

            # 4. ä¸Šä¼ åˆ°COS
            image_url = await cos.upload(result.image, f"slides/{task.slide_id}.png")

            # 5. ç”Ÿæˆç¼©ç•¥å›¾
            thumbnail_url = await generate_thumbnail(result.image, "300x169")

            # 6. æ›´æ–°ä»»åŠ¡å’Œå¹»ç¯ç‰‡
            await db.update_task_result(task.id, {
                "status": "completed",
                "image_url": image_url,
                "thumbnail_url": thumbnail_url
            })

            # 7. æ›´æ–°æ‰¹æ¬¡è¿›åº¦
            await batch_progress_manager.increment_completed(task.batch_id)

        except Exception as e:
            # é”™è¯¯å¤„ç†ï¼šé‡è¯•3æ¬¡åæ ‡è®°ä¸ºå¤±è´¥
            if task.retry_count < 3:
                task.retry_count += 1
                await redis.lpush("generation_queue", task.to_json())
            else:
                await db.update_task_status(task.id, "failed", str(e))
                await batch_progress_manager.increment_failed(task.batch_id)
```

**å‰ç«¯è½®è¯¢æŸ¥è¯¢è¿›åº¦**:

```javascript
// å‰ç«¯è½®è¯¢å®ç°
async function pollProgress(batchId) {
  const timer = setInterval(async () => {
    try {
      const response = await fetch(
        `/api/v1/slide-generations/batches/${batchId}/progress`
      );
      const data = await response.json();

      // ç¬¬1é¡µå®Œæˆæ—¶æ›´æ–°ï¼ˆçº¦5-8ç§’ï¼‰
      if (data.progress.completed_pages >= 1) {
        updateThumbnail(1, data.results[0].thumbnail_url);
        updateProgressBar(25);
      }

      // ç¬¬2é¡µå®Œæˆæ—¶æ›´æ–°ï¼ˆçº¦10-15ç§’ï¼‰
      if (data.progress.completed_pages >= 2) {
        updateThumbnail(2, data.results[1].thumbnail_url);
        updateProgressBar(50);
      }

      // ç¬¬3é¡µå®Œæˆæ—¶æ›´æ–°ï¼ˆçº¦15-22ç§’ï¼‰
      if (data.progress.completed_pages >= 3) {
        updateThumbnail(3, data.results[2].thumbnail_url);
        updateProgressBar(75);
      }

      // æ£€æŸ¥æ˜¯å¦å®Œæˆ
      if (data.status === 'completed') {
        clearInterval(timer);

        // ç¬¬4é¡µå®Œæˆï¼Œæ›´æ–°æœ€åä¸€å¼ 
        updateThumbnail(4, data.results[3].thumbnail_url);
        updateProgressBar(100);

        // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
        showNotification('å¹»ç¯ç‰‡ç”Ÿæˆå®Œæˆï¼', 'success');

        // å¦‚æœæ˜¯å…¨éƒ¨æˆåŠŸ
        if (data.progress.failed_pages === 0) {
          showSuccessDialog();
        } else {
          showPartialSuccessDialog(data.progress.failed_pages);
        }
      }

      if (data.status === 'failed') {
        clearInterval(timer);
        showErrorDialog(data.error_message);
      }

    } catch (error) {
      console.error('è½®è¯¢å¤±è´¥:', error);
      clearInterval(timer);
    }
  }, 2000);  // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡

  return timer;
}

// ä½¿ç”¨ç¤ºä¾‹
const progressTimer = pollProgress('batch_20241220_001');
```

**å¹¶è¡Œç”Ÿæˆä¼˜åŒ–**:

```python
# å¹¶å‘æ§åˆ¶ï¼ˆæœ€å¤š5ä¸ªåŒæ—¶ç”Ÿæˆï¼‰
class ConcurrencyLimiter:
    def __init__(self, max_concurrent=5):
        self.semaphore = asyncio.Semaphore(max_concurrent)

    async def generate_with_limit(self, task):
        async with self.semaphore:
            return await self.generate_single_slide(task)

# Workerè¿›ç¨‹æ± 
workers = [GenerationWorker() for _ in range(5)]
await asyncio.gather(
    *[worker.start() for worker in workers]
)
```

#### 4.2.4 å®Œæˆé˜¶æ®µ (60-65ç§’)

**åç«¯å¤„ç†**:
1. **æ£€æµ‹æ‰¹æ¬¡å®Œæˆ**
   ```python
   batch = await db.get_batch(batch_id)
   if batch.completed_pages + batch.failed_pages >= batch.total_pages:
       # æ‰¹æ¬¡å®Œæˆ
       batch.status = "completed"
       batch.completed_at = datetime.now()
       await db.commit()
   ```

2. **æ¸…ç†è¿‡æœŸæ•°æ®**
   ```python
   # åˆ é™¤Redisä¸­çš„ä¸´æ—¶è¿›åº¦æ•°æ®ï¼ˆä¿ç•™24å°æ—¶ï¼‰
   await redis.expire(f"progress:{batch_id}", 86400)
   ```

3. **å¯é€‰ï¼šç”Ÿæˆå®Œæ•´PPTæ–‡ä»¶**
   ```python
   # å°†æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡åˆå¹¶ä¸ºPPTXæ–‡ä»¶
   pptx_url = await generate_pptx_file(batch.results)
   ```

**å‰ç«¯å¤„ç†**:
1. **æ˜¾ç¤ºå®Œæˆé€šçŸ¥**
   ```javascript
   showNotification({
     title: 'å¹»ç¯ç‰‡ç”Ÿæˆå®Œæˆ',
     message: `æˆåŠŸç”Ÿæˆ ${completed} é¡µï¼Œå¤±è´¥ ${failed} é¡µ`,
     type: 'success'
   });
   ```

2. **å…³é—­è¿›åº¦æµ®çª—**
   ```javascript
   setTimeout(() => {
     hideProgressFloatWindow();
   }, 3000);
   ```

3. **å…¨å±é¢„è§ˆï¼ˆå¯é€‰ï¼‰**
   ```javascript
   if (user_settings.auto_preview) {
     openPreviewMode(batch.slides);
   }
   ```

#### 4.2.5 æœ€ä½³å®è·µä¸ä¼˜åŒ–

**1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
- ç¬¬ä¸€å¼ å›¾ç‰‡ç”Ÿæˆåç«‹å³æ˜¾ç¤ºï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ„Ÿ
- ä½¿ç”¨éª¨æ¶å±ä½œä¸ºå ä½ç¬¦ï¼Œé¿å…ç©ºç™½é¡µé¢
- ç”Ÿæˆè¿‡ç¨‹ä¸­å…è®¸ç”¨æˆ·é¢„è§ˆå·²å®Œæˆçš„å¹»ç¯ç‰‡

**2. æ€§èƒ½ä¼˜åŒ–**:
- ä½¿ç”¨Redisæ’è¡Œæ¦œè®°å½•ç”Ÿæˆé€Ÿåº¦ï¼Œè‡ªåŠ¨è°ƒæ•´å¹¶å‘æ•°
- å®ç°æ™ºèƒ½é‡è¯•ï¼šå¤±è´¥çš„é¡µé¢åœ¨æ‰¹æ¬¡å®Œæˆåè‡ªåŠ¨é‡è¯•
- ä½¿ç”¨CDNç¼“å­˜ç”Ÿæˆçš„å›¾ç‰‡ï¼Œæé«˜åŠ è½½é€Ÿåº¦

**3. é”™è¯¯å¤„ç†**:
- è®°å½•è¯¦ç»†æ—¥å¿—ï¼ˆé¡µé¢ç¼–å·ã€é”™è¯¯ç±»å‹ã€é‡è¯•æ¬¡æ•°ï¼‰
- æä¾›æ‰‹åŠ¨é‡è¯•æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥é‡è¯•å¤±è´¥çš„é¡µé¢
- å¦‚æœè¶…è¿‡50%é¡µé¢å¤±è´¥ï¼Œå»ºè®®ç”¨æˆ·æ£€æŸ¥å¤§çº²æˆ–æ›´æ¢æ¨¡æ¿

### 4.3 é”™è¯¯å¤„ç†æœºåˆ¶

```python
class ErrorHandler:
    """é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶"""

    def __init__(self):
        self.max_retries = 3
        self.retry_delay = [1, 2, 5]  # æŒ‡æ•°é€€é¿

    async def handle_generation_error(self, task: GenerationTask, error: Exception):
        """å¤„ç†ç”Ÿæˆé”™è¯¯"""

        if task.retry_count >= self.max_retries:
            # è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
            await self.mark_failed(task, error)
            return False

        # åˆ¤æ–­é”™è¯¯ç±»å‹
        if isinstance(error, RateLimitError):
            # é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…åé‡è¯•
            delay = self.retry_delay[task.retry_count]
            await asyncio.sleep(delay)

        elif isinstance(error, APIConnectionError):
            # è¿æ¥é”™è¯¯ï¼Œç«‹å³é‡è¯•
            pass

        else:
            # å…¶ä»–é”™è¯¯ï¼Œç­‰å¾…åé‡è¯•
            delay = self.retry_delay[task.retry_count]
            await asyncio.sleep(delay)

        # å¢åŠ é‡è¯•è®¡æ•°å¹¶é‡æ–°å…¥é˜Ÿ
        task.retry_count += 1
        await self.requeue_task(task)

        return True
```

## 5. APIæ¥å£è®¾è®¡ï¼ˆåŸºäºå®é™…å®ç°ï¼‰

### 5.1 æµå¼APIæ¥å£

#### 5.1.1 å¤§çº²ç”Ÿæˆæ¥å£

```http
POST /api/v1/generate/outline
Content-Type: application/json

Request Body:
{
  "topic": "æœ‰ç†æ•°æ¯”è¾ƒ",
  "content": "ã€Šä¸ƒå¹´çº§ä¸ŠÂ·ç¬¬ä¸€ç«  æœ‰ç†æ•°Â·æŠ€æœ¯æ€ç»´æ¨¡å—ã€‹"
}

Response: text/event-stream

data: {"status": "generating"}

data: {"outline": "1. æƒ…å¢ƒå¼•å…¥"}
data: {"outline": "æƒ…å¢ƒå¼•å…¥ï¼šå¿ƒç®—æŒ‘æˆ˜"}

data: {"outline": "2. æ¢ç©¶å»ºæ„"}

data: {"status": "complete", "outline": "å®Œæ•´å¤§çº²"}
```

**å‰ç«¯å¤„ç†ç¤ºä¾‹**ï¼š
```javascript
const reader = response.body.getReader()
const decoder = new TextDecoder()
let fullOutline = ''

while (true) {
  const { done, value } = await reader.read()
  if (done) break

  const lines = decoder.decode(value).split('\n')
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = JSON.parse(line.slice(6))
      if (data.outline) {
        fullOutline += data.outline
      }
    }
  }
}
```

#### 5.1.2 å¹»ç¯ç‰‡ç”Ÿæˆæ¥å£ï¼ˆæµå¼ï¼‰

```http
POST /api/v1/generate/slides
Content-Type: application/json

Request Body:
{
  "outline": "ç¼–è¾‘åçš„å¤§çº²å†…å®¹ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰",
  "language": "ä¸­æ–‡",
  "style": "é€šç”¨",
  "mock_mode": true  // å¯é€‰ï¼Œæ˜¯å¦ä½¿ç”¨mockæ•°æ®
}

Response: text/event-stream

data: {"event": "start", "data": {...}}

data: {"type": "cover", "data": {"title": "...", "text": "..."}}

data: {"type": "contents", "data": {"items": [...]}}

data: {"type": "transition", "data": {"title": "...", "text": "..."}}

data: {"type": "content", "data": {"title": "...", "items": [...]}}

data: {"event": "complete", "data": {"total_slides": 14, "generation_time": 5.23}}
```

**é‡è¦è¯´æ˜**ï¼š
- å½“å‰å®ç°ä¸éœ€è¦ `outline_id`ï¼Œè€Œæ˜¯ç›´æ¥ä¼ é€’å¤§çº²å†…å®¹
- ä¸éœ€è¦ `template_id`ï¼Œæ¨¡æ¿é€‰æ‹©åœ¨å‰ç«¯é™æ€é…ç½®ä¸­ç®¡ç†
- ä¸éœ€è¦ `batch_id`ï¼Œæµå¼å“åº”ä¸­æ²¡æœ‰æ‰¹æ¬¡IDè¿½è¸ª
- çŠ¶æ€ç®¡ç†åœ¨**å‰ç«¯å®Œæˆ**ï¼Œé€šè¿‡SSEäº‹ä»¶å®ç°å®æ—¶æ¸²æŸ“

#### 5.1.3 å“åº”æ•°æ®æ ¼å¼

**å¼€å§‹äº‹ä»¶ï¼ˆstartï¼‰**ï¼š
```json
{
  "event": "start",
  "data": {
    "content_length": 1036,
    "language": "ä¸­æ–‡",
    "style": "é€šç”¨",
    "mock_mode": true,
    "timestamp": 1766229144.456243,
    "operation_type": "slides_generation"
  }
}
```

**å°é¢é¡µï¼ˆcoverï¼‰**ï¼š
```json
{
  "type": "cover",
  "data": {
    "title": "æ„æ€æ¯”è¾ƒçš„ç›´æ¥æ³•åˆ™",
    "text": "ã€Šä¸ƒå¹´çº§ä¸ŠÂ·ç¬¬ä¸€ç«  æœ‰ç†æ•°Â·æŠ€æœ¯æ€ç»´æ¨¡å—ã€‹"
  }
}
```

**ç›®å½•é¡µï¼ˆcontentsï¼‰**ï¼š
```json
{
  "type": "contents",
  "data": {
    "items": ["æƒ…å¢ƒå¼•å…¥", "æ¢ç©¶å»ºæ„", "æŠ€æœ¯æ–¹æ¡ˆ", "æµ‹è¯„éªŒè¯", "æ€è€ƒè¡¨è¾¾"]
  }
}
```

**è¿‡æ¸¡é¡µï¼ˆtransitionï¼‰**ï¼š
```json
{
  "type": "transition",
  "data": {
    "title": "æƒ…å¢ƒå¼•å…¥ï¼šå¿ƒç®—æŒ‘æˆ˜",
    "text": "é€šè¿‡ç”Ÿæ´»æƒ…å¢ƒå¼•å…¥æœ‰ç†æ•°æ¯”è¾ƒçš„æŒ‘æˆ˜"
  }
}
```

**å†…å®¹é¡µï¼ˆcontentï¼‰**ï¼š
```json
{
  "type": "content",
  "data": {
    "title": "è„‘åŠ›å¤§æ¯”æ‹¼",
    "semanticFeatures": {
      "logicType": "sequential",
      "contentType": "lesson_introduction"
    },
    "items": [
      {
        "title": "",
        "text": "æŠ¥å‡ºä¸€ç»„æ•°ï¼Œ-5â„ƒå’Œ-12â„ƒï¼Œä½ èƒ½ç«‹åˆ»åˆ¤å®šå“ªä¸ªæ›´å¤§å—ï¼Ÿ",
        "metadata": {}
      }
    ]
  }
}
```

**å®Œæˆäº‹ä»¶ï¼ˆcompleteï¼‰**ï¼š
```json
{
  "event": "complete",
  "data": {
    "total_slides": 14,
    "generation_time": 5.227701902389526,
    "mock_mode": true,
    "operation_type": "slides_generation"
  }
}
```

### 6.1 æç¤ºè¯ç”Ÿæˆç­–ç•¥

å‚è€ƒ banana-slides çš„å®ç°ï¼Œæç¤ºè¯åˆ†ä¸ºä¸‰å±‚æ¶æ„ï¼š

#### 6.1.1 å¤§çº²è½¬é¡µé¢æè¿°

```python
PAGE_DESCRIPTION_PROMPT = """
åŸºäºä»¥ä¸‹PPTå¤§çº²çš„JSONç»“æ„ï¼Œä¸ºç¬¬{page_index}é¡µç”Ÿæˆè¯¦ç»†çš„é¡µé¢æè¿°ã€‚

å¤§çº²ç»“æ„:
{outline}

æœ¬é¡µå¤§çº²:
{page_outline}

è¦æ±‚:
1. æè¿°åº”ä¸ºçº¯æ–‡æœ¬ï¼Œä¸åŒ…å«Markdownæ ¼å¼
2. è¯¦ç»†è¯´æ˜é¡µé¢çš„å†…å®¹ã€å¸ƒå±€å’Œè§†è§‰å…ƒç´ 
3. åŒ…æ‹¬æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€æ­£æ–‡ã€å›¾è¡¨ã€å›¾ç‰‡ä½ç½®ç­‰
4. å­—æ•°æ§åˆ¶åœ¨200-400å­—ä¹‹é—´
5. æè¿°è¦å…·ä½“ï¼Œä¾¿äºAIç†è§£ç”Ÿæˆ

è¾“å‡ºæ ¼å¼:
{{"description": "è¯¦ç»†çš„é¡µé¢æè¿°"}}
"""
```

#### 6.1.2 æè¿°è½¬å›¾ç‰‡ç”Ÿæˆæç¤ºè¯

```python
IMAGE_GENERATION_PROMPT = """
ä½ æ˜¯ä¸€åä¸“ä¸šçš„PPTè®¾è®¡å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹æè¿°ç”Ÿæˆé«˜è´¨é‡çš„å¹»ç¯ç‰‡å›¾ç‰‡ã€‚

æè¿°å†…å®¹:
{page_description}

å½“å‰ç« èŠ‚:
{current_section}

æ•´ä½“å¤§çº²:
{outline_text}

é£æ ¼è¦æ±‚:
1. ä½¿ç”¨{style}é£æ ¼ï¼Œå‚è€ƒæ¨¡æ¿:{template_name}
2. é…è‰²æ–¹æ¡ˆ: {color_scheme}
3. åˆ†è¾¨ç‡: {resolution}
4. é•¿å®½æ¯”: {aspect_ratio}

å¸ƒå±€è¦æ±‚:
1. ä¸¥æ ¼æŒ‰ç…§16:9æ¯”ä¾‹
2. æ ‡é¢˜åœ¨ä¸Šæ–¹å±…ä¸­æˆ–å·¦å¯¹é½
3. å†…å®¹åŒºåŸŸåœ¨ä¸‹æ–¹ï¼Œåˆç†ç•™ç™½
4. å¦‚éœ€å›¾è¡¨ï¼Œä½¿ç”¨æ¸…æ™°çš„æ•°æ®å¯è§†åŒ–

æ–‡å­—æ¸²æŸ“:
1. æ‰€æœ‰æ–‡å­—å¿…é¡»æ¸…æ™°å¯è¯»ï¼Œä¸æ¨¡ç³Š
2. å­—ä½“å¤§å°é€‚ä¸­ï¼Œæ ‡é¢˜24-36ptï¼Œæ­£æ–‡18-24pt
3. ä¸­è‹±æ–‡æ··æ’æ—¶ä¿æŒç¾è§‚

è¾“å‡ºè¦æ±‚:
ç›´æ¥ç”Ÿæˆå®Œæ•´çš„å¹»ç¯ç‰‡å›¾ç‰‡ï¼Œä¸è¦æœ‰ä»»ä½•è¾¹æ¡†æˆ–æ°´å°ã€‚
"""
```

#### 6.1.3 æ¨¡æ¿å¢å¼ºæç¤ºè¯

```python
TEMPLATE_ENHANCEMENT_PROMPT = """
åŸºäºä»¥ä¸‹æ¨¡æ¿é£æ ¼ç”Ÿæˆç±»ä¼¼çš„å¹»ç¯ç‰‡:

å‚è€ƒæ¨¡æ¿å›¾ç‰‡ï¼š{template_image}

æ¨¡æ¿ç‰¹å¾åˆ†æ:
- é…è‰²æ–¹æ¡ˆ: {palette}
- å­—ä½“é£æ ¼: {typography}
- å¸ƒå±€ç‰¹ç‚¹: {layout_style}
- è£…é¥°å…ƒç´ : {decorative_elements}

è¯·æ ¹æ®ä»¥ä¸Šé£æ ¼ç‰¹å¾ï¼Œç”Ÿæˆæ–°çš„å¹»ç¯ç‰‡é¡µé¢ï¼š
{page_description}

è¦æ±‚ä¿æŒé£æ ¼ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œå±•ç¤ºæ–°çš„å†…å®¹ã€‚
"""
```

### 6.2 æç¤ºè¯ä¼˜åŒ–æŠ€å·§

å‚è€ƒ banana-slides çš„æœ€ä½³å®è·µï¼š

1. **ç»“æ„åŒ–è¾“å‡º**: ä½¿ç”¨JSONæ ¼å¼ç¡®ä¿è¾“å‡ºä¸€è‡´æ€§
2. **æ€è€ƒè¿‡ç¨‹**: æ·»åŠ thinking_budgetå‚æ•°æ§åˆ¶æ€è€ƒæ·±åº¦
3. **å¤šè¯­è¨€æ”¯æŒ**: æ ¹æ®ç”¨æˆ·é€‰æ‹©è‡ªåŠ¨é€‚é…è¯­è¨€æç¤ºè¯
4. **ä¸Šä¸‹æ–‡å¢å¼º**: åŒ…å«å‰åæ–‡ä¿¡æ¯æé«˜è¿è´¯æ€§

```python
def optimize_prompt_for_nano_banana(base_prompt: str) -> str:
    """
    ä¸“ä¸ºnano banana proä¼˜åŒ–çš„æç¤ºè¯
    """

    enhancements = [
        "ä½¿ç”¨æœ€ä½³è´¨é‡",
        "è¶…é«˜åˆ†è¾¨ç‡",
        "ä¸“ä¸šè®¾è®¡",
        "æ¸…æ™°çš„æ–‡æœ¬æ¸²æŸ“",
        "ç²¾ç¡®çš„æ’ç‰ˆ",
        "æ— æ°´å°",
        "æ— è£…é¥°è¾¹æ¡†"
    ]

    optimized = f"""
{base_prompt}

é£æ ¼è´¨é‡è¦æ±‚:
{', '.join(enhancements)}

æ³¨æ„:
ç”Ÿæˆçš„å›¾ç‰‡å¿…é¡»èƒ½ç›´æ¥ç”¨äºPPTï¼Œæ‰€æœ‰æ–‡å­—å†…å®¹å¿…é¡»å®Œæ•´å‘ˆç°ä¸”æ¸…æ™°ã€‚
"""

    return optimized
```

## 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 å¹¶å‘æ§åˆ¶

```python
from asyncio import Semaphore

class ConcurrencyLimiter:
    """å¹¶å‘é™åˆ¶å™¨"""

    def __init__(self, max_concurrent: int = 5):
        self.semaphore = Semaphore(max_concurrent)
        self.max_concurrent = max_concurrent

    async def acquire(self):
        await self.semaphore.acquire()

    def release(self):
        self.semaphore.release()

    async def __aenter__(self):
        await self.acquire()
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        self.release()
```

### 7.2 ç¼“å­˜ç­–ç•¥

```python
class GenerationCache:
    """ç”Ÿæˆç»“æœç¼“å­˜"""

    def __init__(self):
        self.redis = RedisClient()
        self.ttl = 3600 * 24  # 24å°æ—¶

    async def get_cached_result(self, cache_key: str) -> Optional[str]:
        """è·å–ç¼“å­˜ç»“æœ"""
        return await self.redis.get(f"generation:{cache_key}")

    async def cache_result(self, cache_key: str, image_url: str):
        """ç¼“å­˜ç”Ÿæˆç»“æœ"""
        await self.redis.setex(
            f"generation:{cache_key}",
            self.ttl,
            image_url
        )

    def generate_cache_key(self, params: dict) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        import hashlib
        import json

        sorted_params = dict(sorted(params.items()))
        params_str = json.dumps(sorted_params, ensure_ascii=False)
        return hashlib.md5(params_str.encode()).hexdigest()
```

### 7.3 é˜Ÿåˆ—ç®¡ç†

```python
from celery import Celery

app = Celery('slide_generation')
app.conf.update(
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',
    timezone='UTC',
    enable_utc=True,
    broker_url='redis://localhost:6379/0',
    result_backend='redis://localhost:6379/0',
    task_routes={
        'nano_banana.generate_slide': {'queue': 'generation'},
    },
    task_annotations={
        'nano_banana.generate_slide': {
            'rate_limit': '10/m',  # æ¯åˆ†é’Ÿæœ€å¤š10ä¸ª
        },
    }
)
```

## 8. ç›‘æ§ä¸æ—¥å¿—

### 8.2 æ—¥å¿—è§„èŒƒ

```python
import structlog

logger = structlog.get_logger()

async def generate_slide(self, task: GenerationTask):
    """å¸¦ç»“æ„åŒ–æ—¥å¿—çš„ç”Ÿæˆæ–¹æ³•"""

    logger.info(
        "slide_generation_started",
        batch_id=task.batch_id,
        slide_id=task.slide_id,
        page_number=task.page_number,
        template_id=task.template_id,
        prompt_length=len(task.prompt)
    )

    try:
        # ç”Ÿæˆé€»è¾‘...

        logger.info(
            "slide_generation_completed",
            batch_id=task.batch_id,
            slide_id=task.slide_id,
            duration=duration,
            image_size=image_size
        )

    except Exception as e:
        logger.error(
            "slide_generation_failed",
            batch_id=task.batch_id,
            slide_id=task.slide_id,
            error_type=type(e).__name__,
            error_message=str(e),
            retry_count=task.retry_count
        )
        raise

## 9. ä»£ç ç›®å½•ç»„ç»‡ç»“æ„

æœ¬èŠ‚è¯´æ˜ä¸ºå®ç° nano banana pro é›†æˆï¼Œé¡¹ç›®ä¸­æ–°å¢çš„ä»£ç æ–‡ä»¶åŠå…¶ä½ç½®ã€‚

### 9.1 åç«¯ä»£ç ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ endpoints/
â”‚   â”‚           â”œâ”€â”€ __init__.py
â”‚   â”‚           â”œâ”€â”€ slide_generation.py           # [æ–°å¢] å¹»ç¯ç‰‡ç”ŸæˆAPI
â”‚   â”‚           â””â”€â”€ ai_model.py                   # [æ‰©å±•] AIæ¨¡å‹ç®¡ç†API
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ image_generation/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py                           # [å·²æœ‰] å›¾ç‰‡ç”ŸæˆåŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ factory.py                        # [æ‰©å±•] æ·»åŠ nano bananaæ”¯æŒ
â”‚   â”‚   â”‚   â””â”€â”€ providers/
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ nano_banana.py                # [æ–°å¢] NanoBananaProvider
â”‚   â”‚   â”‚       â”œâ”€â”€ openai_compatible.py          # [å·²æœ‰]
â”‚   â”‚   â”‚       â”œâ”€â”€ gemini.py                     # [å·²æœ‰]
â”‚   â”‚   â”‚       â”œâ”€â”€ qwen.py                       # [å·²æœ‰]
â”‚   â”‚   â”‚       â””â”€â”€ volcengine_ark.py            # [å·²æœ‰]
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ config.py                            # [æ‰©å±•] æ·»åŠ nano bananaé…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ ai_model.py                          # [å·²æœ‰] AIæ¨¡å‹è¡¨
â”‚   â”‚   â”œâ”€â”€ generation_batch.py                  # [æ–°å¢] ç”Ÿæˆæ‰¹æ¬¡æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ generation_task.py                   # [æ–°å¢] ç”Ÿæˆä»»åŠ¡æ¨¡å‹
â”‚   â”‚   â””â”€â”€ slide_template.py                    # [æ–°å¢] å¹»ç¯ç‰‡æ¨¡æ¿æ¨¡å‹ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ ai_model.py                          # [å·²æœ‰] AIæ¨¡å‹ä»“åº“
â”‚   â”‚   â”œâ”€â”€ generation_batch.py                  # [æ–°å¢] æ‰¹æ¬¡ä»“åº“
â”‚   â”‚   â””â”€â”€ generation_task.py                   # [æ–°å¢] ä»»åŠ¡ä»“åº“
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ nano_banana/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ batch_generation_service.py      # [æ–°å¢] æ‰¹æ¬¡ç”ŸæˆæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ generation_orchestrator.py       # [æ–°å¢] ç”Ÿæˆç¼–æ’å™¨ï¼ˆBatchGenerationOrchestratorï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ progress_manager.py              # [æ–°å¢] è¿›åº¦ç®¡ç†æœåŠ¡
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ai_service.py                        # [æ‰©å±•] æ·»åŠ å›¾ç‰‡ç”Ÿæˆæ–¹æ³•
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ cos_uploader.py                      # [æ–°å¢] COSä¸Šä¼ å·¥å…·
â”‚       â”œâ”€â”€ image_processor.py                   # [æ–°å¢] å›¾ç‰‡å¤„ç†å·¥å…·ï¼ˆç”Ÿæˆç¼©ç•¥å›¾ç­‰ï¼‰
â”‚       â””â”€â”€ download.py                          # [æ–°å¢] å›¾ç‰‡ä¸‹è½½å·¥å…·
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ test_nano_banana_provider.py         # [æ–°å¢] NanoBananaProviderå•å…ƒæµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_batch_generation.py             # [æ–°å¢] æ‰¹æ¬¡ç”ŸæˆæœåŠ¡å•å…ƒæµ‹è¯•
â”‚   â”‚
â”‚   â””â”€â”€ integration/
â”‚       â””â”€â”€ test_slide_generation_flow.py        # [æ–°å¢] é›†æˆæµ‹è¯•
â”‚
â””â”€â”€ migrations/
    â””â”€â”€ versions/
        â””â”€â”€ 003_add_generation_tables.py         # [æ–°å¢] æ•°æ®åº“è¿ç§»è„šæœ¬
```

### 9.2 å‰ç«¯ä»£ç ç»“æ„

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ TemplateSelector.vue               # [æ–°å¢] æ¨¡æ¿é€‰æ‹©å™¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ GenerationProgressFloat.vue        # [æ–°å¢] ç”Ÿæˆè¿›åº¦æµ®çª—
â”‚   â”‚   â””â”€â”€ BatchGenerationDialog.vue          # [æ–°å¢] æ‰¹é‡ç”Ÿæˆå¯¹è¯æ¡†
â”‚   â”‚
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ Editor/
â”‚   â”‚       â”œâ”€â”€ AIPPTDialog.vue                # [å·²æœ‰] å¤§çº²ç”Ÿæˆå¯¹è¯æ¡†
â”‚   â”‚       â””â”€â”€ index.vue                      # [æ‰©å±•] æ·»åŠ é¦™è•‰ç”ŸæˆæŒ‰é’®
â”‚   â”‚
â”‚   â”œâ”€â”€ configs/
â”‚   â”‚   â””â”€â”€ nanoBananaTemplates.ts             # [æ–°å¢] nano bananaæ¨¡æ¿é…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useBatchGeneration.ts              # [æ–°å¢] æ‰¹é‡ç”Ÿæˆç»„åˆå‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â””â”€â”€ slides.ts                          # [æ‰©å±•] æ·»åŠ ç”ŸæˆçŠ¶æ€ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ client.ts                          # [æ‰©å±•] æ·»åŠ ç”Ÿæˆç›¸å…³API
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ index.ts                           # [æ‰©å±•] æ·»åŠ ç”Ÿæˆç›¸å…³ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ public/
â”‚   â””â”€â”€ imgs/
â”‚       â””â”€â”€ nano_banana/                       # [æ–°å¢] æ¨¡æ¿å›¾ç‰‡å­˜å‚¨ç›®å½•
â”‚           â”œâ”€â”€ business_pro.png
â”‚           â”œâ”€â”€ tech_future.png
â”‚           â””â”€â”€ ... (æ›´å¤šæ¨¡æ¿å›¾ç‰‡)
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â”‚   â””â”€â”€ TemplateSelector.spec.ts           # [æ–°å¢] æ¨¡æ¿é€‰æ‹©å™¨æµ‹è¯•
    â”‚
    â””â”€â”€ integration/
        â””â”€â”€ generate_slides.spec.ts            # [æ–°å¢] ç”Ÿæˆæµç¨‹é›†æˆæµ‹è¯•
```

### 9.3 å…³é”®ä»£ç æ–‡ä»¶è¯´æ˜

#### 9.3.1 BatchGenerationOrchestrator ä½ç½®è¯´æ˜

`BatchGenerationOrchestrator` å±äº**ç”Ÿæˆç¼–æ’æœåŠ¡**ï¼Œä½äºï¼š

```
backend/app/services/nano_banana/generation_orchestrator.py
```

**èŒè´£**: è´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€å¹¶å‘æ§åˆ¶ã€è¿›åº¦ç®¡ç†ã€é”™è¯¯å¤„ç†ç­‰æ ¸å¿ƒç¼–æ’é€»è¾‘ã€‚

**ä¸ Banana-Slides å¯¹æ¯”**:
- banana-slides: `backend/services/task_manager.py` (è´Ÿè´£ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†)
- ai-pptist: `generation_orchestrator.py` (æ›´å®Œæ•´çš„ç¼–æ’é€»è¾‘)

**ä¸ºä»€ä¹ˆä¸å¤ç”¨ ai_service.py?**

å‚è€ƒä»£ç  `banana-slides/backend/services/ai_service.py` çš„ `generate_image` æ–¹æ³•è™½ç„¶æœ‰å‚è€ƒå›¾å¤„ç†é€»è¾‘ï¼Œä½†ï¼š

1. **æ¶æ„å·®å¼‚**ï¼šbanana-slidesæ˜¯å•ä½“æœåŠ¡ï¼Œç›´æ¥è°ƒç”¨æä¾›å•†ï¼›ai-pptisté‡‡ç”¨åˆ†å±‚æ¶æ„ï¼ˆAPIå±‚â†’æœåŠ¡å±‚â†’æä¾›å•†å±‚ï¼‰ï¼Œæ›´è§£è€¦
2. **åŠŸèƒ½å·®å¼‚**ï¼šai-pptistéœ€è¦æ”¯æŒæ‰¹é‡ç”Ÿæˆã€è¿›åº¦ç®¡ç†ã€å¹¶å‘æ§åˆ¶ç­‰å¤æ‚åœºæ™¯
3. **æ‰©å±•æ€§**ï¼šç‹¬ç«‹å®ç°æ›´ä¾¿äºåç»­æ·»åŠ A/Bæµ‹è¯•ã€å¤šæ¨¡å‹å¹¶è¡Œç­‰åŠŸèƒ½
4. **APIå…¼å®¹æ€§**ï¼šnano banana proä½¿ç”¨OpenAIæ ¼å¼ï¼Œä½†è¿”å›å¤„ç†æœ‰å·®å¼‚ï¼Œéœ€è¦å®šåˆ¶

**å®ç°ç­–ç•¥**:
- **å¤ç”¨åŸºç¡€è®¾æ–½**ï¼šç»§æ‰¿ `BaseImageProvider`ï¼Œè‡ªåŠ¨è·å¾— MLflow è¿½è¸ªã€é”™è¯¯å¤„ç†ã€æ—¥å¿—
- **å¤åˆ¶æ ¸å¿ƒé€»è¾‘**ï¼šå‚è€ƒå‚è€ƒä»£ç çš„å‚è€ƒå›¾å¤„ç†æ–¹å¼ï¼Œåœ¨ `_generate_image_internal` ä¸­å®ç°
- **å¢å¼ºåŠŸèƒ½**ï¼šæ·»åŠ å¹¶å‘é™åˆ¶ã€æ™ºèƒ½é‡è¯•ã€è¿›åº¦è¿½è¸ªç­‰ä¼ä¸šçº§ç‰¹æ€§

#### 9.3.2 NanoBananaProvider å®ç°è¯´æ˜

- **ä½ç½®**: `backend/app/core/image_generation/providers/nano_banana.py`
- **è®¾è®¡**: ç»§æ‰¿ `BaseImageProvider`ï¼Œå®ç° `ImageProvider` æ¥å£
- **æ ¸å¿ƒæ–¹æ³•**: `_generate_image_internal` (ä¸å‚è€ƒä»£ç ä¸€è‡´ï¼Œæ”¯æŒå‚è€ƒå›¾)
- **è¿½è¸ª**: é€šè¿‡åŸºç±»è‡ªåŠ¨è·å¾— MLflow è¿½è¸ªã€æˆæœ¬ç»Ÿè®¡ã€å“åº”æ—¶é—´ç›‘æ§

#### 9.3.3 å‰ç«¯æ¨¡æ¿ç®¡ç†

- **é…ç½®ä½ç½®**: `frontend/src/configs/nanoBananaTemplates.ts`
- **å›¾ç‰‡ä½ç½®**: `frontend/public/imgs/nano_banana/`
- **ç‰¹ç‚¹**: é™æ€é…ç½®ï¼Œæ— éœ€åç«¯æ”¯æŒï¼Œé€‚åˆå¿«é€ŸDEMOéªŒè¯

### 9.4 æ•°æ®åº“è¡¨ç»“æ„å˜åŒ–

**æ–°å¢è¡¨**:
```sql
-- ç”Ÿæˆæ‰¹æ¬¡è¡¨
CREATE TABLE generation_batches (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    outline_id VARCHAR(36) NOT NULL,
    template_id VARCHAR(36) NOT NULL,
    status VARCHAR(20) NOT NULL,
    total_pages INTEGER NOT NULL DEFAULT 0,
    completed_pages INTEGER NOT NULL DEFAULT 0,
    failed_pages INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    completed_at TIMESTAMP,
    INDEX idx_user_outline (user_id, outline_id)
);

-- ç”Ÿæˆä»»åŠ¡è¡¨
CREATE TABLE generation_tasks (
    id VARCHAR(36) PRIMARY KEY,
    batch_id VARCHAR(36) NOT NULL,
    slide_id VARCHAR(36) NOT NULL,
    page_number INTEGER NOT NULL,
    prompt TEXT NOT NULL,
    status VARCHAR(20) NOT NULL,
    retry_count INTEGER NOT NULL DEFAULT 0,
    image_url VARCHAR(500),
    thumbnail_url VARCHAR(500),
    error_message TEXT,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    FOREIGN KEY (batch_id) REFERENCES generation_batches(id)
);
```

**æ‰©å±•è¡¨**:
```sql
-- ai_models è¡¨ï¼ˆå·²æœ‰ï¼Œæ·»åŠ æ–°å­—æ®µï¼‰
ALTER TABLE ai_models ADD COLUMN supports_image_generation BOOLEAN DEFAULT false;
ALTER TABLE ai_models ADD COLUMN config JSONB DEFAULT '{}';
```

### 9.5 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env
# ========== Nano Banana Pro é…ç½® ==========
# å›¾ç‰‡ç”Ÿæˆé…ç½®
NANO_BANANA_API_BASE=https://api.nanobanana.com/v1
NANO_BANANA_TIMEOUT=120

# ç”Ÿæˆä»»åŠ¡é™åˆ¶
MAX_CONCURRENT_GENERATIONS=5      # æœ€å¤§å¹¶å‘ç”Ÿæˆæ•°
DEFAULT_IMAGE_SIZE=1536x864       # é»˜è®¤å›¾ç‰‡å°ºå¯¸ï¼ˆ16:9ï¼‰
DEFAULT_IMAGE_QUALITY=hd         # é»˜è®¤å›¾ç‰‡è´¨é‡
IMAGE_THUMBNAIL_SIZE=300x169     # ç¼©ç•¥å›¾å°ºå¯¸

# å­˜å‚¨é…ç½®
COS_BUCKET_SLIDES=pptist-slides  # COSå­˜å‚¨æ¡¶ï¼ˆå¹»ç¯ç‰‡å›¾ç‰‡ï¼‰
CDN_IMAGE_URL=https://cdn.pptist.com  # CDNåŠ é€ŸåŸŸå
```

### 9.6 å¯åŠ¨æ–‡ä»¶å˜åŒ–

**æ–°å¢WorkeræœåŠ¡**:
```python
# backend/app/worker.py

from app.services.nano_banana.batch_generation_service import BatchGenerationService

if __name__ == "__main__":
    # å¯åŠ¨ç”Ÿæˆå·¥ä½œè¿›ç¨‹
    service = BatchGenerationService()
    asyncio.run(service.start_workers())
```

**å¯åŠ¨æ–¹å¼**:
```bash
# ä¸»APIæœåŠ¡
uvicorn main:app --host 0.0.0.0 --port 8000

# ç”ŸæˆWorkeræœåŠ¡ï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰
python backend/app/worker.py --concurrency 5
```

### 9.7 æ–‡ä»¶å˜æ›´æ±‡æ€»

| ç±»åˆ« | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| åç«¯æ–°å¢æ–‡ä»¶ | 9ä¸ª | APIç«¯ç‚¹ã€æœåŠ¡ã€æ¨¡å‹ã€ä»“åº“ç­‰ |
| åç«¯ä¿®æ”¹æ–‡ä»¶ | 3ä¸ª | config.pyã€factory.pyç­‰ |
| å‰ç«¯æ–°å¢æ–‡ä»¶ | 6ä¸ª | ç»„ä»¶ã€é…ç½®ã€hooksç­‰ |
| å‰ç«¯ä¿®æ”¹æ–‡ä»¶ | 3ä¸ª | ç°æœ‰æ–‡ä»¶æ‰©å±• |
| æ•°æ®åº“è¿ç§» | 1ä¸ª | æ–°å¢2å¼ è¡¨ï¼Œæ‰©å±•1å¼ è¡¨ |
| æµ‹è¯•æ–‡ä»¶ | 4ä¸ª | å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |

**æ€»è®¡**: 26ä¸ªæ–‡ä»¶å˜æ›´ï¼Œå…¶ä¸­19ä¸ªæ–°å¢æ–‡ä»¶ï¼Œ7ä¸ªç°æœ‰æ–‡ä»¶ä¿®æ”¹æ‰©å±•ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-12-20  17:45:00
**æ›´æ–°è®°å½•**:
- v2.0: ä¼˜åŒ–ä¸ºDemoå¿«é€ŸéªŒè¯ç‰ˆæœ¬
  - åˆ é™¤WebSocketï¼Œæ”¹ä¸ºè½®è¯¢
  - è¡¥å……è¯¦ç»†å‰åç«¯åä½œæµç¨‹
  - ä¼˜åŒ–NanoBananaProvideræ”¯æŒå‚è€ƒå›¾
  - æ·»åŠ å®Œæ•´ä»£ç ç›®å½•ç»„ç»‡ç»“æ„
- v1.0: åˆå§‹ç‰ˆæœ¬
