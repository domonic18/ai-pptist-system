# PPTå†…å®¹æ’ç‰ˆä¼˜åŒ–åŠŸèƒ½æ¶æ„è®¾è®¡ - å®Œå–„ç‰ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.1 (è¯„å®¡åå®Œå–„ç‰ˆ)  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
> **æœ€åæ›´æ–°**: 2025-10-28  
> **çŠ¶æ€**: å·²è¯„å®¡ï¼Œå¾…å¼€å‘

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£åŸºäºè¯„å®¡æŠ¥å‘Šçš„å»ºè®®å’Œé¡¹ç›®æ—¢æœ‰è§„èŒƒï¼Œå¯¹åŸæ¶æ„è®¾è®¡è¿›è¡Œäº†å®Œå–„ï¼š

### ä¸»è¦è°ƒæ•´
1. âœ… **æ¥å£å¥‘çº¦ç»Ÿä¸€**ï¼šå…¨é¢é‡‡ç”¨ `StandardResponse(status/message/data)` æ ¼å¼
2. âœ… **åˆ†å±‚æ¶æ„å®Œå–„**ï¼šå¢åŠ Handlerå±‚ï¼ˆç½‘ç»œå±‚é€»è¾‘ï¼‰+ Serviceå±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
3. âœ… **è·¯ç”±è§„èŒƒå¯¹é½**ï¼šéµå¾ªé¡¹ç›®è·¯ç”±ç®¡ç†è§„èŒƒï¼ˆendpointä½¿ç”¨ç©ºå­—ç¬¦ä¸²ï¼Œrouter.pyç»Ÿä¸€ç®¡ç†prefixï¼‰
4. âœ… **æ—¥å¿—è§„èŒƒç»Ÿä¸€**ï¼šä½¿ç”¨log_messageså’Œç»“æ„åŒ–æ—¥å¿—
5. âœ… **é”™è¯¯ç ä½“ç³»**ï¼šä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç åˆ†ç±»
6. âœ… **ä»£ç ç¤ºä¾‹æ›´æ–°**ï¼šæ‰€æœ‰ä»£ç ç¤ºä¾‹ç¬¦åˆé¡¹ç›®è§„èŒƒ
7. âœ… **LLMäº¤äº’ä¼˜åŒ–**ï¼šé‡‡ç”¨HTMLç”Ÿæˆæ–¹å¼ï¼Œåˆ©ç”¨LLMæ“…é•¿HTMLçš„ç‰¹æ€§æé«˜è¾“å‡ºè´¨é‡

### æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

ğŸ’¡ **[HTMLç”Ÿæˆä¸DOMè§£ææ–¹æ¡ˆ](./HTMLç”Ÿæˆä¸DOMè§£ææ–¹æ¡ˆ.md)** - è¯¦ç»†çš„æŠ€æœ¯å®ç°æŒ‡å—ï¼ŒåŒ…å«å®Œæ•´ä»£ç ç¤ºä¾‹

---

## ç›®å½•
1. [æ•´ä½“æ¶æ„è®¾è®¡æ¡†æ¶](#1-æ•´ä½“æ¶æ„è®¾è®¡æ¡†æ¶)
2. [æ•°æ®æ ¼å¼è®¾è®¡](#2-æ•°æ®æ ¼å¼è®¾è®¡)
3. [æ ¸å¿ƒå®ç°æµç¨‹](#3-æ ¸å¿ƒå®ç°æµç¨‹)
4. [å‰ç«¯å®ç°æ–¹æ¡ˆ](#4-å‰ç«¯å®ç°æ–¹æ¡ˆ)
5. [åç«¯å®ç°æ–¹æ¡ˆ](#5-åç«¯å®ç°æ–¹æ¡ˆ)
6. [é”™è¯¯å¤„ç†å’Œå®¹é”™](#6-é”™è¯¯å¤„ç†å’Œå®¹é”™)
7. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#7-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ)
8. [æµ‹è¯•æ–¹æ¡ˆ](#8-æµ‹è¯•æ–¹æ¡ˆ)
9. [å®æ–½è·¯çº¿å›¾](#9-å®æ–½è·¯çº¿å›¾)

---

## 1. æ•´ä½“æ¶æ„è®¾è®¡æ¡†æ¶

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å‰ç«¯å±‚ (Vue 3)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ é­”æœ¯æŒ‰é’®ç»„ä»¶  â”‚  â”‚ æ•°æ®æ”¶é›†æœåŠ¡  â”‚  â”‚ çŠ¶æ€ç®¡ç†     â”‚    â”‚
â”‚  â”‚ MagicButton   â”‚  â”‚ Optimization  â”‚  â”‚ Slides Store â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                â”‚
â”‚                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          API Service (optimization.ts)               â”‚   â”‚
â”‚  â”‚  â€¢ è¯·æ±‚æ„å»º   â€¢ çŠ¶æ€ç®¡ç†   â€¢ é”™è¯¯å¤„ç†               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTP POST /api/v1/layout/optimize
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åç«¯å±‚ (FastAPI)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Endpoint: layout_optimization.py (è½»è·¯ç”±)        â”‚   â”‚
â”‚  â”‚  â€¢ å‚æ•°éªŒè¯   â€¢ è°ƒç”¨Handler   â€¢ è¿”å›StandardResponseâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Handler: LayoutOptimizationHandler (é‡å¤„ç†)     â”‚   â”‚
â”‚  â”‚  â€¢ ç½‘ç»œå±‚é€»è¾‘  â€¢ æ—¥å¿—è®°å½•  â€¢ å¼‚å¸¸å¤„ç†  â€¢ ç¼“å­˜æ£€æŸ¥ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Service: LayoutOptimizationService (æ ¸å¿ƒä¸šåŠ¡)   â”‚   â”‚
â”‚  â”‚  â€¢ HTMLç”Ÿæˆ  â€¢ LLMè°ƒç”¨  â€¢ DOMè§£æ  â€¢ æ•°æ®éªŒè¯     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                 â”‚                      â”‚                    â”‚
â”‚                 â–¼                      â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   HTMLè½¬æ¢å·¥å…·       â”‚  â”‚  ç»“æœéªŒè¯å·¥å…·           â”‚   â”‚
â”‚  â”‚  â€¢ PPTistâ†’HTML      â”‚  â”‚  â€¢ å…ƒç´ IDä¸€è‡´æ€§         â”‚   â”‚
â”‚  â”‚  â€¢ DOMâ†’PPTist       â”‚  â”‚  â€¢ å†…å®¹ä¸å˜æ ¡éªŒ         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LLMæœåŠ¡å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ AIClient    â”‚  â”‚ OpenAI API  â”‚  â”‚ Azure OpenAIâ”‚         â”‚
â”‚  â”‚ (å°è£…)      â”‚â”€â”€â–¶â”‚             â”‚  â”‚             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ”¯æ’‘æœåŠ¡å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Redisç¼“å­˜   â”‚  â”‚ MLflowè¿½è¸ª  â”‚  â”‚ æ—¥å¿—æœåŠ¡    â”‚         â”‚
â”‚  â”‚ (å†…å®¹å“ˆå¸Œ)  â”‚  â”‚ (AIè¿½è¸ª)    â”‚  â”‚ (ç»“æ„åŒ–)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åˆ†å±‚èŒè´£è¯´æ˜

#### Endpoint å±‚ï¼ˆè½»è·¯ç”±ï¼‰
- âœ… å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- âœ… Pydanticå‚æ•°éªŒè¯
- âœ… è°ƒç”¨Handlerå¤„ç†ä¸šåŠ¡
- âœ… è¿”å›StandardResponse

#### Handler å±‚ï¼ˆé‡å¤„ç†ï¼‰
- âœ… ç½‘ç»œå±‚å¼‚å¸¸å¤„ç†
- âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… ç¼“å­˜æ£€æŸ¥å’Œç®¡ç†
- âœ… è°ƒç”¨Serviceæ‰§è¡Œä¸šåŠ¡

#### Service å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
- âœ… ä¸šåŠ¡é€»è¾‘å®ç°
- âœ… HTMLç”Ÿæˆï¼ˆPPTistå…ƒç´  â†’ HTMLï¼‰
- âœ… LLMæ¨¡å‹è°ƒç”¨ï¼ˆHTMLä¼˜åŒ–ï¼‰
- âœ… DOMè§£æï¼ˆä¼˜åŒ–åHTML â†’ PPTistå…ƒç´ ï¼‰
- âœ… æ•°æ®éªŒè¯å’Œè¿”å›

---

## 2. æ•°æ®æ ¼å¼è®¾è®¡

### 2.1 å‰ç«¯æ•°æ®ç»“æ„

#### ä¼˜åŒ–è¯·æ±‚æ¥å£

```typescript
// frontend/src/types/optimization.ts

/**
 * ä¼˜åŒ–è¯·æ±‚æ•°æ®
 */
export interface OptimizationRequest {
  slide_id: string;
  elements: SimplifiedElement[];
  canvas_size: {
    width: number;
    height: number;
  };
  options?: {
    keep_colors?: boolean;
    keep_fonts?: boolean;
    style?: 'professional' | 'creative' | 'minimal';
  };
}

/**
 * ç²¾ç®€å…ƒç´ æ•°æ®ï¼ˆä»…ä¼ è¾“å¿…è¦å­—æ®µï¼‰
 */
export interface SimplifiedElement {
  id: string;
  type: string;
  left: number;
  top: number;
  width: number;
  height: number;
  rotate: number;
  // ç±»å‹ç‰¹å®šå­—æ®µ
  content?: string;  // textç±»å‹
  defaultFontName?: string;
  defaultColor?: string;
  fill?: string;  // shapeç±»å‹
  src?: string;  // imageç±»å‹
}

/**
 * ä¼˜åŒ–å“åº”ï¼ˆç¬¦åˆStandardResponseè§„èŒƒï¼‰
 */
export interface OptimizationResponse {
  status: 'success' | 'error' | 'warning';
  message: string;
  data?: {
    slide_id: string;
    elements: SimplifiedElement[];
    description?: string;
    duration?: number;
  };
  error_code?: string;
  error_details?: any;
}
```

### 2.2 åç«¯æ•°æ®ç»“æ„

#### Pydanticæ¨¡å‹å®šä¹‰

```python
# backend/app/schemas/layout_optimization.py

from typing import List, Optional, Dict, Any
from pydantic import BaseModel, Field

class CanvasSize(BaseModel):
    """ç”»å¸ƒå°ºå¯¸"""
    width: float = Field(..., gt=0, description="ç”»å¸ƒå®½åº¦")
    height: float = Field(..., gt=0, description="ç”»å¸ƒé«˜åº¦")

class OptimizationOptions(BaseModel):
    """ä¼˜åŒ–é€‰é¡¹"""
    keep_colors: bool = Field(default=False, description="ä¿æŒåŸæœ‰é¢œè‰²")
    keep_fonts: bool = Field(default=False, description="ä¿æŒåŸæœ‰å­—ä½“")
    style: str = Field(
        default="professional",
        pattern="^(professional|creative|minimal)$",
        description="ä¼˜åŒ–é£æ ¼"
    )

class ElementData(BaseModel):
    """å…ƒç´ æ•°æ®"""
    id: str = Field(..., description="å…ƒç´ ID")
    type: str = Field(..., description="å…ƒç´ ç±»å‹ï¼štext/shape/imageç­‰")
    left: float = Field(..., description="Xåæ ‡")
    top: float = Field(..., description="Yåæ ‡")
    width: float = Field(..., gt=0, description="å®½åº¦")
    height: float = Field(..., gt=0, description="é«˜åº¦")
    rotate: float = Field(default=0, description="æ—‹è½¬è§’åº¦")
    
    # å¯é€‰å±æ€§ï¼ˆæ ¹æ®typeä¸åŒè€Œä¸åŒï¼‰
    content: Optional[str] = None
    defaultFontName: Optional[str] = None
    defaultColor: Optional[str] = None
    lineHeight: Optional[float] = None
    fill: Optional[str] = None
    outline: Optional[Dict[str, Any]] = None
    text: Optional[Dict[str, Any]] = None
    src: Optional[str] = None
    fixedRatio: Optional[bool] = None

class LayoutOptimizationRequest(BaseModel):
    """å¸ƒå±€ä¼˜åŒ–è¯·æ±‚"""
    slide_id: str = Field(..., description="å¹»ç¯ç‰‡ID")
    elements: List[ElementData] = Field(
        ..., 
        min_length=1,
        max_length=50,
        description="å…ƒç´ åˆ—è¡¨ï¼ˆ1-50ä¸ªï¼‰"
    )
    canvas_size: CanvasSize = Field(..., description="ç”»å¸ƒå°ºå¯¸")
    options: Optional[OptimizationOptions] = Field(
        default=None,
        description="ä¼˜åŒ–é€‰é¡¹"
    )

class LayoutOptimizationResponseData(BaseModel):
    """å¸ƒå±€ä¼˜åŒ–å“åº”æ•°æ®ï¼ˆdataå­—æ®µå†…å®¹ï¼‰"""
    slide_id: str = Field(..., description="å¹»ç¯ç‰‡ID")
    elements: List[ElementData] = Field(..., description="ä¼˜åŒ–åçš„å…ƒç´ åˆ—è¡¨")
    description: Optional[str] = Field(
        default=None,
        description="ä¼˜åŒ–è¯´æ˜"
    )
    duration: Optional[float] = Field(
        default=None,
        description="ä¼˜åŒ–è€—æ—¶ï¼ˆç§’ï¼‰"
    )
```

### 2.3 LLMäº¤äº’æ ¼å¼

**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼šåˆ©ç”¨LLMæ“…é•¿HTMLçš„ç‰¹æ€§ï¼Œå°†PPTistå…ƒç´ è½¬æ¢ä¸ºHTMLæ ¼å¼ï¼Œè€ŒéJSONã€‚è¿™æ ·å¯ä»¥ï¼š
- âœ… æé«˜LLMç†è§£å’Œç”Ÿæˆè´¨é‡
- âœ… å‡å°‘è‡ªå®šä¹‰æ•°æ®ç»“æ„çš„å­¦ä¹ æˆæœ¬  
- âœ… åˆ©ç”¨HTMLè¯­ä¹‰åŒ–ç‰¹æ€§æ›´å¥½åœ°è¡¨è¾¾å¸ƒå±€

#### LLMè¾“å…¥æ ¼å¼

```html
<!-- ç”»å¸ƒå°ºå¯¸: 1000x562.5 -->
<div class="ppt-canvas" style="width: 1000px; height: 562.5px; position: relative; background: white;">
  
  <!-- æ–‡æœ¬å…ƒç´  -->
  <div 
    class="ppt-element ppt-text" 
    data-id="el_001" 
    data-type="text"
    style="
      position: absolute;
      left: 100px;
      top: 50px;
      width: 600px;
      height: 80px;
      transform: rotate(0deg);
      font-family: 'Microsoft YaHei';
      font-size: 24px;
      color: #333333;
      line-height: 1.5;
    ">
    å¹»ç¯ç‰‡æ ‡é¢˜
  </div>
  
  <!-- å½¢çŠ¶å…ƒç´  -->
  <div 
    class="ppt-element ppt-shape" 
    data-id="el_002" 
    data-type="shape"
    data-shape-type="rect"
    style="
      position: absolute;
      left: 100px;
      top: 150px;
      width: 760px;
      height: 300px;
      background-color: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px;
    ">
    <div class="shape-text" style="padding: 20px; font-size: 16px; color: #666;">
      å†…å®¹æè¿°æ–‡å­—
    </div>
  </div>
  
  <!-- å›¾ç‰‡å…ƒç´  -->
  <img 
    class="ppt-element ppt-image" 
    data-id="el_003" 
    data-type="image"
    src="https://example.com/image.jpg"
    style="
      position: absolute;
      left: 50px;
      top: 200px;
      width: 200px;
      height: 150px;
      object-fit: cover;
    "
  />
  
</div>
```

**æ•°æ®å±æ€§è¯´æ˜**ï¼š
- `data-id`: å…ƒç´ å”¯ä¸€æ ‡è¯†ï¼ˆå¿…é¡»ä¿æŒä¸å˜ï¼‰
- `data-type`: å…ƒç´ ç±»å‹ï¼ˆtext/shape/imageï¼‰
- `data-shape-type`: å½¢çŠ¶ç±»å‹ï¼ˆä»…shapeå…ƒç´ ï¼‰
- `style`: å†…è”æ ·å¼åŒ…å«ä½ç½®ã€å°ºå¯¸ã€æ ·å¼ä¿¡æ¯

#### LLMè¾“å‡ºæ ¼å¼

LLMè¿”å›ä¼˜åŒ–åçš„HTMLï¼Œä¿æŒç›¸åŒçš„ç»“æ„å’Œdataå±æ€§ï¼š

```html
<div class="ppt-canvas" style="width: 1000px; height: 562.5px; position: relative; background: white;">
  
  <!-- ä¼˜åŒ–åçš„æ–‡æœ¬å…ƒç´ ï¼šè°ƒæ•´ä½ç½®ã€å­—ä½“å¤§å° -->
  <div 
    class="ppt-element ppt-text" 
    data-id="el_001" 
    data-type="text"
    style="
      position: absolute;
      left: 150px;
      top: 80px;
      width: 700px;
      height: 100px;
      transform: rotate(0deg);
      font-family: 'Microsoft YaHei';
      font-size: 42px;
      font-weight: bold;
      color: #1a1a1a;
      line-height: 1.2;
      text-align: center;
    ">
    å¹»ç¯ç‰‡æ ‡é¢˜
  </div>
  
  <!-- ä¼˜åŒ–åçš„å½¢çŠ¶å…ƒç´ ï¼šè°ƒæ•´ä½ç½®å’Œé¢œè‰² -->
  <div 
    class="ppt-element ppt-shape" 
    data-id="el_002" 
    data-type="shape"
    data-shape-type="rect"
    style="
      position: absolute;
      left: 120px;
      top: 220px;
      width: 760px;
      height: 280px;
      background-color: #f8f9fa;
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    ">
    <div class="shape-text" style="padding: 24px; font-size: 18px; color: #333; line-height: 1.6;">
      å†…å®¹æè¿°æ–‡å­—
    </div>
  </div>
  
  <!-- ä¼˜åŒ–åçš„å›¾ç‰‡å…ƒç´ ï¼šè°ƒæ•´å¤§å°å’Œä½ç½® -->
  <img 
    class="ppt-element ppt-image" 
    data-id="el_003" 
    data-type="image"
    src="https://example.com/image.jpg"
    style="
      position: absolute;
      left: 80px;
      top: 240px;
      width: 240px;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
    "
  />
  
</div>

<!-- ä¼˜åŒ–è¯´æ˜ -->
<!-- 
ä¼˜åŒ–è¦ç‚¹ï¼š
1. æ ‡é¢˜å­—ä½“å¢å¤§è‡³42pxå¹¶åŠ ç²—ï¼Œæå‡è§†è§‰å±‚æ¬¡
2. æ ‡é¢˜å±…ä¸­å¯¹é½ï¼Œå¢å¼ºè§†è§‰ç„¦ç‚¹
3. å½¢çŠ¶å…ƒç´ æ·»åŠ é˜´å½±ï¼Œå¢å¼ºç«‹ä½“æ„Ÿ
4. æ•´ä½“å¸ƒå±€ç•™ç™½æ›´åˆç†ï¼Œè§†è§‰å¹³è¡¡æ„Ÿæ›´å¼º
-->
```

**è¾“å‡ºçº¦æŸ**ï¼š
1. âœ… å¿…é¡»ä¿æŒæ‰€æœ‰ `data-id` ä¸å˜
2. âœ… æ–‡æœ¬å†…å®¹ç»å¯¹ä¸èƒ½ä¿®æ”¹
3. âœ… ä»…è°ƒæ•´ä½ç½®ã€å°ºå¯¸ã€æ ·å¼å±æ€§
4. âœ… è¿”å›å®Œæ•´çš„HTMLç»“æ„

---

## 3. æ ¸å¿ƒå®ç°æµç¨‹

### 3.1 å®Œæ•´æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as MagicButton
    participant API as API Service
    participant Endpoint as Endpoint
    participant Handler as Handler
    participant Service as Service
    participant Cache as Redis
    participant LLM as LLM/AIClient

    User->>UI: ç‚¹å‡»é­”æœ¯æŒ‰é’®
    UI->>UI: æ˜¾ç¤ºLoading
    UI->>API: è°ƒç”¨optimizeSlideLayout()
    
    API->>API: ç²¾ç®€å…ƒç´ æ•°æ®
    API->>Endpoint: POST /api/v1/layout/optimize
    
    Endpoint->>Endpoint: PydanticéªŒè¯
    Endpoint->>Handler: è°ƒç”¨handle_optimize_layout()
    
    Handler->>Handler: è®°å½•å¼€å§‹æ—¥å¿—
    Handler->>Cache: æ£€æŸ¥ç¼“å­˜
    
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>Handler: è¿”å›ç¼“å­˜æ•°æ®
        Handler->>Handler: è®°å½•ç¼“å­˜å‘½ä¸­æ—¥å¿—
    else ç¼“å­˜æœªå‘½ä¸­
        Handler->>Service: è°ƒç”¨optimize_layout()
        
        Service->>Service: 1. è½¬æ¢PPTistå…ƒç´ ä¸ºHTML
        Service->>Service: 2. æ„å»ºHTMLä¼˜åŒ–Prompt
        Service->>LLM: 3. è°ƒç”¨AIæ¨¡å‹ï¼ˆä¼ å…¥HTMLï¼‰
        LLM-->>Service: 4. è¿”å›ä¼˜åŒ–åçš„HTML
        Service->>Service: 5. è§£æHTML DOM
        Service->>Service: 6. è½¬æ¢DOMä¸ºPPTistå…ƒç´ 
        Service->>Service: 7. éªŒè¯ç»“æœï¼ˆIDã€å†…å®¹ä¸€è‡´æ€§ï¼‰
        Service-->>Handler: è¿”å›ä¼˜åŒ–æ•°æ®
        
        Handler->>Cache: å­˜å‚¨åˆ°ç¼“å­˜
        Handler->>Handler: è®°å½•æˆåŠŸæ—¥å¿—
    end
    
    Handler-->>Endpoint: è¿”å›ä¼˜åŒ–æ•°æ®
    Endpoint-->>API: StandardResponse
    API-->>UI: è¿”å›ç»“æœ
    
    UI->>UI: æ·»åŠ å†å²å¿«ç…§
    UI->>UI: æ›´æ–°Slides Store
    UI->>UI: éšè—Loading
    UI-->>User: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
```

---

## 4. å‰ç«¯å®ç°æ–¹æ¡ˆ

### 4.1 APIé…ç½®

é¦–å…ˆåœ¨ `frontend/src/configs/api.ts` ä¸­æ·»åŠ å¸ƒå±€ä¼˜åŒ–APIé…ç½®ï¼š

```typescript
// frontend/src/configs/api.ts

export const API_CONFIG = {
  // ... å…¶ä»–APIé…ç½®
  
  // å¸ƒå±€ä¼˜åŒ–ç›¸å…³API
  LAYOUT: {
    // ä¼˜åŒ–å¹»ç¯ç‰‡å¸ƒå±€
    OPTIMIZE: '/api/v1/layout/optimize',
  },
  
  // ...
} as const
```

### 4.2 APIæœåŠ¡æ¨¡å—

```typescript
// frontend/src/services/optimization.ts

import { api } from './api';
import API_CONFIG from '@/configs/api';
import type { PPTElement } from '@/types/slides';
import type { 
  OptimizationRequest,
  OptimizationResponse,
  SimplifiedElement 
} from '@/types/optimization';

/**
 * ç²¾ç®€å…ƒç´ æ•°æ®ï¼ˆä»…ä¼ è¾“å¿…è¦å­—æ®µï¼‰
 */
function simplifyElement(element: PPTElement): SimplifiedElement {
  const base = {
    id: element.id,
    type: element.type,
    left: element.left,
    top: element.top,
    width: element.width,
    height: element.height,
    rotate: element.rotate,
  };

  // æ ¹æ®å…ƒç´ ç±»å‹æ·»åŠ ç‰¹å®šå­—æ®µ
  switch (element.type) {
    case 'text':
      return {
        ...base,
        content: element.content,
        defaultFontName: element.defaultFontName,
        defaultColor: element.defaultColor,
        lineHeight: element.lineHeight,
      };
    case 'shape':
      return {
        ...base,
        fill: element.fill,
        outline: element.outline,
        text: element.text,
      };
    case 'image':
      return {
        ...base,
        src: element.src,
        fixedRatio: element.fixedRatio,
      };
    default:
      return base;
  }
}

/**
 * ä¼˜åŒ–å¹»ç¯ç‰‡å¸ƒå±€
 */
export async function optimizeSlideLayout(
  slideId: string,
  elements: PPTElement[],
  canvasSize: { width: number; height: number },
  options?: OptimizationRequest['options']
): Promise<OptimizationResponse> {
  try {
    // ç²¾ç®€å…ƒç´ æ•°æ®
    const simplifiedElements = elements.map(simplifyElement);

    // æ„å»ºè¯·æ±‚
    const request: OptimizationRequest = {
      slide_id: slideId,
      elements: simplifiedElements,
      canvas_size: canvasSize,
      options,
    };

    // ä½¿ç”¨API_CONFIGç»Ÿä¸€ç®¡ç†çš„ç«¯ç‚¹
    const response = await api.post<OptimizationResponse>(
      API_CONFIG.LAYOUT.OPTIMIZE,
      request
    );

    return response.data;

  } catch (error: any) {
    console.error('ä¼˜åŒ–è¯·æ±‚å¤±è´¥:', error);
    
    // è¿”å›ç¬¦åˆStandardResponseæ ¼å¼çš„é”™è¯¯
    return {
      status: 'error',
      message: error.response?.data?.message || error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
      error_code: error.response?.data?.error_code || 'NETWORK_ERROR',
      error_details: error.response?.data?.error_details,
    };
  }
}
```

### 4.3 é­”æœ¯æŒ‰é’®ç»„ä»¶

```vue
<!-- frontend/src/views/Editor/Toolbar/MagicButton.vue -->
<template>
  <div class="magic-button-wrapper">
    <el-tooltip
      content="æ™ºèƒ½ä¼˜åŒ–å½“å‰å¹»ç¯ç‰‡æ’ç‰ˆ"
      placement="bottom"
      :disabled="loading"
    >
      <el-button
        class="magic-button"
        :class="{ 'is-loading': loading }"
        :disabled="loading || disabled"
        @click="handleOptimize"
      >
        <svg-icon
          name="magic-wand"
          class="magic-icon"
          :class="{ 'rotating': loading }"
        />
        <span v-if="!loading">ä¼˜åŒ–æ’ç‰ˆ</span>
        <span v-else>ä¼˜åŒ–ä¸­...</span>
      </el-button>
    </el-tooltip>
  </div>
</template>

<script lang="ts" setup>
import { ref, computed } from 'vue';
import { storeToRefs } from 'pinia';
import { useSlidesStore } from '@/store';
import { message } from '@/utils/message';
import { optimizeSlideLayout } from '@/services/optimization';
import { useHistorySnapshot } from '@/hooks/useHistorySnapshot';

const slidesStore = useSlidesStore();
const { currentSlide, viewportSize, viewportRatio } = storeToRefs(slidesStore);
const { addHistorySnapshot } = useHistorySnapshot();

const loading = ref(false);

// ç¦ç”¨æ¡ä»¶ï¼šæ²¡æœ‰å…ƒç´ æˆ–æ­£åœ¨åŠ è½½
const disabled = computed(() => {
  return !currentSlide.value || 
         currentSlide.value.elements.length === 0;
});

// å¤„ç†ä¼˜åŒ–è¯·æ±‚
const handleOptimize = async () => {
  if (!currentSlide.value) {
    message.error('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¹»ç¯ç‰‡');
    return;
  }

  if (currentSlide.value.elements.length === 0) {
    message.error('å½“å‰å¹»ç¯ç‰‡æ²¡æœ‰å¯ä¼˜åŒ–çš„å…ƒç´ ');
    return;
  }

  loading.value = true;

  try {
    // è°ƒç”¨ä¼˜åŒ–æœåŠ¡
    const response = await optimizeSlideLayout(
      currentSlide.value.id,
      currentSlide.value.elements,
      {
        width: viewportSize.value,
        height: viewportSize.value * viewportRatio.value
      }
    );

    // æ£€æŸ¥StandardResponseçš„statuså­—æ®µ
    if (response.status === 'success' && response.data) {
      // æ·»åŠ å†å²å¿«ç…§ï¼ˆæ”¯æŒæ’¤é”€ï¼‰
      addHistorySnapshot();

      // æ›´æ–°å¹»ç¯ç‰‡å…ƒç´ 
      slidesStore.updateSlide({
        elements: response.data.elements
      });

      message.success(response.message || 'æ’ç‰ˆä¼˜åŒ–å®Œæˆï¼');
    } else {
      throw new Error(response.message || 'ä¼˜åŒ–å¤±è´¥');
    }
  } catch (error: any) {
    console.error('ä¼˜åŒ–å¤±è´¥:', error);
    message.error(`æ’ç‰ˆä¼˜åŒ–å¤±è´¥ï¼š${error.message}`);
  } finally {
    loading.value = false;
  }
};
</script>

<style lang="scss" scoped>
// æ ·å¼ä»£ç ä¿æŒä¸å˜
</style>
```

---

## 5. åç«¯å®ç°æ–¹æ¡ˆ

### 5.1 è·¯ç”±æ³¨å†Œ

```python
# backend/app/api/v1/router.py

from fastapi import APIRouter
from app.api.v1.endpoints import (
    image_manager,
    image_search,
    image_upload,
    image_tags,
    tags,
    generation,
    ai_model,
    layout_optimization,  # æ–°å¢
)

api_router = APIRouter()

# æ³¨å†Œå„æ¨¡å—è·¯ç”± - ç»Ÿä¸€åœ¨æ­¤ç®¡ç†å‰ç¼€
api_router.include_router(image_manager.router, prefix="/images", tags=["å›¾ç‰‡ç®¡ç†"])
api_router.include_router(image_upload.router, prefix="/images", tags=["å›¾ç‰‡ä¸Šä¼ "])
api_router.include_router(image_search.router, prefix="/images", tags=["å›¾ç‰‡æœç´¢"])
api_router.include_router(image_tags.router, prefix="/images", tags=["å›¾ç‰‡æ ‡ç­¾"])
api_router.include_router(tags.router, prefix="/tags", tags=["æ ‡ç­¾ç®¡ç†"])
api_router.include_router(generation.router, prefix="/generate", tags=["AI Generation"])
api_router.include_router(ai_model.router, prefix="/models", tags=["AI Models"])
api_router.include_router(layout_optimization.router, prefix="/layout", tags=["å¸ƒå±€ä¼˜åŒ–"])  # æ–°å¢
```

### 5.2 Endpointå±‚å®ç°

```python
# backend/app/api/v1/endpoints/layout_optimization.py

"""
å¸ƒå±€ä¼˜åŒ–APIç«¯ç‚¹ï¼ˆè½»è·¯ç”±ï¼‰
è´Ÿè´£å‚æ•°éªŒè¯ã€è°ƒç”¨Handlerã€è¿”å›æ ‡å‡†å“åº”
"""

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession

from app.db.database import get_db
from app.schemas.layout_optimization import (
    LayoutOptimizationRequest,
    LayoutOptimizationResponseData
)
from app.schemas.common import StandardResponse
from app.services.layout.layout_optimization_handler import LayoutOptimizationHandler
from app.core.log_utils import get_logger

logger = get_logger(__name__)

# æ³¨æ„ï¼šä½¿ç”¨ç©ºå­—ç¬¦ä¸²""ä½œä¸ºæ ¹è·¯å¾„ï¼Œprefixåœ¨router.pyä¸­ç»Ÿä¸€ç®¡ç†
router = APIRouter(tags=["å¸ƒå±€ä¼˜åŒ–"])


@router.post(
    "/optimize",  # å®Œæ•´è·¯å¾„ï¼š/api/v1/layout/optimize
    response_model=StandardResponse,
    summary="ä¼˜åŒ–å¹»ç¯ç‰‡å¸ƒå±€",
    description="ä½¿ç”¨LLMæ™ºèƒ½ä¼˜åŒ–å¹»ç¯ç‰‡çš„æ’ç‰ˆå¸ƒå±€ï¼Œä¿æŒå†…å®¹ä¸å˜"
)
async def optimize_slide_layout(
    request: LayoutOptimizationRequest,
    db: AsyncSession = Depends(get_db)
) -> StandardResponse:
    """
    ä¼˜åŒ–å¹»ç¯ç‰‡å¸ƒå±€çš„APIç«¯ç‚¹
    
    Args:
        request: å¸ƒå±€ä¼˜åŒ–è¯·æ±‚ï¼ˆPydanticè‡ªåŠ¨éªŒè¯ï¼‰
        db: æ•°æ®åº“ä¼šè¯
        
    Returns:
        StandardResponse: æ ‡å‡†å“åº”æ ¼å¼
            - status: "success" | "error" | "warning"
            - message: å“åº”æ¶ˆæ¯
            - data: LayoutOptimizationResponseData | None
            - error_code: é”™è¯¯ç ï¼ˆå¯é€‰ï¼‰
            - error_details: é”™è¯¯è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
    """
    try:
        # è°ƒç”¨Handlerå¤„ç†ä¸šåŠ¡
        handler = LayoutOptimizationHandler(db)
        result = await handler.handle_optimize_layout(request)
        
        # è¿”å›æ ‡å‡†å“åº”
        return StandardResponse(
            status="success",
            message="å¸ƒå±€ä¼˜åŒ–å®Œæˆ",
            data=result
        )
        
    except HTTPException:
        # FastAPIä¼šè‡ªåŠ¨å¤„ç†HTTPException
        raise
        
    except Exception as e:
        # æ•è·æœªé¢„æœŸçš„å¼‚å¸¸
        logger.error(
            "å¸ƒå±€ä¼˜åŒ–ç«¯ç‚¹å¼‚å¸¸",
            operation="optimize_slide_layout_endpoint",
            slide_id=request.slide_id if request else None,
            error=str(e),
            error_type=type(e).__name__
        )
        
        return StandardResponse(
            status="error",
            message="å¸ƒå±€ä¼˜åŒ–å¤±è´¥",
            error_code="LAYOUT_OPTIMIZATION_ERROR",
            error_details={"error": str(e)}
        )
```

### 5.3 Handlerå±‚å®ç°

```python
# backend/app/services/layout/layout_optimization_handler.py

"""
å¸ƒå±€ä¼˜åŒ–Handlerï¼ˆé‡å¤„ç†ï¼‰
è´Ÿè´£ç½‘ç»œå±‚é€»è¾‘ã€æ—¥å¿—è®°å½•ã€å¼‚å¸¸å¤„ç†ã€ç¼“å­˜ç®¡ç†
"""

import time
import hashlib
import json
from typing import Dict, Any, Optional
from fastapi import HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession

from app.services.layout.layout_optimization_service import LayoutOptimizationService
from app.schemas.layout_optimization import (
    LayoutOptimizationRequest,
    LayoutOptimizationResponseData
)
from app.core.log_utils import get_logger
from app.core.log_messages import log_messages

logger = get_logger(__name__)


class LayoutOptimizationHandler:
    """å¸ƒå±€ä¼˜åŒ–å¤„ç†å™¨"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.service = LayoutOptimizationService(db)
        
    def _generate_cache_key(self, request: LayoutOptimizationRequest) -> str:
        """ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºå†…å®¹å“ˆå¸Œï¼‰"""
        data = {
            "elements": [el.model_dump() for el in request.elements],
            "canvas_size": request.canvas_size.model_dump(),
            "options": request.options.model_dump() if request.options else {}
        }
        
        content_hash = hashlib.sha256(
            json.dumps(data, sort_keys=True).encode()
        ).hexdigest()
        
        return f"layout_opt:{content_hash[:16]}"
    
    async def handle_optimize_layout(
        self,
        request: LayoutOptimizationRequest
    ) -> LayoutOptimizationResponseData:
        """
        å¤„ç†å¸ƒå±€ä¼˜åŒ–è¯·æ±‚
        
        Args:
            request: å¸ƒå±€ä¼˜åŒ–è¯·æ±‚
            
        Returns:
            LayoutOptimizationResponseData: ä¼˜åŒ–ç»“æœ
            
        Raises:
            HTTPException: HTTPå¼‚å¸¸
        """
        start_time = time.time()
        
        try:
            # è®°å½•å¼€å§‹æ—¥å¿—ï¼ˆä½¿ç”¨log_messagesï¼‰
            logger.info(
                log_messages.START_OPERATION,
                operation_name="å¸ƒå±€ä¼˜åŒ–",
                slide_id=request.slide_id,
                elements_count=len(request.elements)
            )
            
            # TODO: æ£€æŸ¥Redisç¼“å­˜ï¼ˆç¬¬äºŒé˜¶æ®µå®ç°ï¼‰
            # cache_key = self._generate_cache_key(request)
            # cached_result = await self._get_from_cache(cache_key)
            # if cached_result:
            #     logger.info(log_messages.OPERATION_SUCCESS, 
            #                 operation_name="å¸ƒå±€ä¼˜åŒ–ï¼ˆç¼“å­˜ï¼‰",
            #                 cache_key=cache_key)
            #     return cached_result
            
            # è°ƒç”¨Serviceæ‰§è¡Œä¸šåŠ¡é€»è¾‘
            optimized_elements = await self.service.optimize_layout(
                slide_id=request.slide_id,
                elements=request.elements,
                canvas_size=request.canvas_size,
                options=request.options
            )
            
            # æ„å»ºå“åº”æ•°æ®
            duration = time.time() - start_time
            result = LayoutOptimizationResponseData(
                slide_id=request.slide_id,
                elements=optimized_elements,
                duration=duration
            )
            
            # TODO: å­˜å‚¨åˆ°Redisç¼“å­˜ï¼ˆç¬¬äºŒé˜¶æ®µå®ç°ï¼‰
            # await self._save_to_cache(cache_key, result)
            
            # è®°å½•æˆåŠŸæ—¥å¿—
            logger.info(
                log_messages.OPERATION_SUCCESS,
                operation_name="å¸ƒå±€ä¼˜åŒ–",
                slide_id=request.slide_id,
                duration_ms=int(duration * 1000),
                elements_count=len(optimized_elements)
            )
            
            return result
            
        except ValueError as e:
            # ä¸šåŠ¡éªŒè¯å¼‚å¸¸
            logger.warning(
                "å¸ƒå±€ä¼˜åŒ–éªŒè¯å¤±è´¥",
                operation="handle_optimize_layout",
                slide_id=request.slide_id,
                error=str(e)
            )
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=str(e)
            )
            
        except Exception as e:
            # å…¶ä»–å¼‚å¸¸
            duration = time.time() - start_time
            logger.error(
                log_messages.OPERATION_FAILED,
                operation_name="å¸ƒå±€ä¼˜åŒ–",
                slide_id=request.slide_id,
                duration_ms=int(duration * 1000),
                error=str(e),
                error_type=type(e).__name__
            )
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail=f"å¸ƒå±€ä¼˜åŒ–å¤±è´¥ï¼š{str(e)}"
            )
```

### 5.4 Serviceå±‚å®ç°

```python
# backend/app/services/layout/layout_optimization_service.py

"""
å¸ƒå±€ä¼˜åŒ–Serviceï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
è´Ÿè´£æ•°æ®è½¬æ¢ã€LLMè°ƒç”¨ã€ç»“æœè§£æã€æ•°æ®éªŒè¯
"""

from typing import List, Optional, Dict, Any
import json
import re
from sqlalchemy.ext.asyncio import AsyncSession

from app.schemas.layout_optimization import (
    ElementData,
    CanvasSize,
    OptimizationOptions
)
from app.core.llm.client import AIClient
from app.core.log_utils import get_logger
from app.prompts.utils import load_prompt_template

logger = get_logger(__name__)


class LayoutOptimizationService:
    """å¸ƒå±€ä¼˜åŒ–æœåŠ¡ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.ai_client = AIClient()
        
    async def optimize_layout(
        self,
        slide_id: str,
        elements: List[ElementData],
        canvas_size: CanvasSize,
        options: Optional[OptimizationOptions] = None
    ) -> List[ElementData]:
        """
        ä¼˜åŒ–å¹»ç¯ç‰‡å¸ƒå±€çš„æ ¸å¿ƒæ–¹æ³•
        
        Args:
            slide_id: å¹»ç¯ç‰‡ID
            elements: å…ƒç´ åˆ—è¡¨
            canvas_size: ç”»å¸ƒå°ºå¯¸
            options: ä¼˜åŒ–é€‰é¡¹
            
        Returns:
            List[ElementData]: ä¼˜åŒ–åçš„å…ƒç´ åˆ—è¡¨
            
        Raises:
            ValueError: éªŒè¯å¤±è´¥
            Exception: å…¶ä»–å¼‚å¸¸
        """
        logger.info(
            "å¼€å§‹æ‰§è¡Œå¸ƒå±€ä¼˜åŒ–",
            operation="optimize_layout",
            slide_id=slide_id,
            elements_count=len(elements)
        )
        
        try:
            # 1. è½¬æ¢PPTistå…ƒç´ ä¸ºHTML
            html_content = self._convert_to_html(
                elements, canvas_size
            )
            logger.info(
                "PPTistå…ƒç´ å·²è½¬æ¢ä¸ºHTML",
                operation="convert_to_html",
                html_length=len(html_content)
            )
            
            # 2. æ„å»ºæç¤ºè¯
            system_prompt = self._build_system_prompt()
            user_prompt = self._build_user_prompt(html_content, canvas_size, options)
            
            # 3. è°ƒç”¨LLMï¼ˆä½¿ç”¨ç°æœ‰AIClientï¼‰
            logger.info(
                "è°ƒç”¨LLMè¿›è¡ŒHTMLå¸ƒå±€ä¼˜åŒ–",
                operation="optimize_layout_llm_call",
                slide_id=slide_id
            )
            
            llm_response = await self.ai_client.ai_call(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                temperature=0.7,
                max_tokens=3000  # HTMLéœ€è¦æ›´å¤štoken
            )
            
            logger.info(
                "LLM HTMLå“åº”æ¥æ”¶å®Œæˆ",
                operation="optimize_layout_llm_response",
                response_length=len(llm_response)
            )
            
            # 4. è§£æHTMLå“åº”ï¼Œæå–çº¯HTMLå†…å®¹
            optimized_html = self._extract_html_from_response(llm_response)
            
            # 5. è§£æHTML DOMï¼Œè½¬æ¢ä¸ºPPTistå…ƒç´ 
            optimized_elements = self._parse_html_to_elements(
                optimized_html, elements
            )
            
            # 6. éªŒè¯ç»“æœï¼ˆç¡®ä¿å†…å®¹ä¸å˜ã€IDä¸€è‡´ç­‰ï¼‰
            self._validate_optimized_elements(optimized_elements, elements)
            
            logger.info(
                "å¸ƒå±€ä¼˜åŒ–æ‰§è¡ŒæˆåŠŸ",
                operation="optimize_layout_success",
                slide_id=slide_id,
                optimized_count=len(optimized_elements)
            )
            
            return optimized_elements
            
        except Exception as e:
            logger.error(
                "å¸ƒå±€ä¼˜åŒ–æ‰§è¡Œå¤±è´¥",
                operation="optimize_layout_failed",
                slide_id=slide_id,
                error=str(e),
                error_type=type(e).__name__
            )
            raise
    
    def _convert_to_html(
        self,
        elements: List[ElementData],
        canvas_size: CanvasSize
    ) -> str:
        """
        å°†PPTistå…ƒç´ è½¬æ¢ä¸ºHTMLæ ¼å¼
        åˆ©ç”¨LLMæ“…é•¿HTMLçš„ç‰¹æ€§
        """
        html_parts = [
            f'<div class="ppt-canvas" style="width: {canvas_size.width}px; height: {canvas_size.height}px; position: relative; background: white;">\n'
        ]
        
        for el in elements:
            if el.type == 'text':
                html_parts.append(self._element_to_html_text(el))
            elif el.type == 'shape':
                html_parts.append(self._element_to_html_shape(el))
            elif el.type == 'image':
                html_parts.append(self._element_to_html_image(el))
        
        html_parts.append('</div>')
        return '\n'.join(html_parts)
    
    def _element_to_html_text(self, el: ElementData) -> str:
        """æ–‡æœ¬å…ƒç´ è½¬HTML"""
        styles = [
            'position: absolute',
            f'left: {el.left}px',
            f'top: {el.top}px',
            f'width: {el.width}px',
            f'height: {el.height}px',
            f'transform: rotate({el.rotate}deg)',
        ]
        
        if el.defaultFontName:
            styles.append(f"font-family: '{el.defaultFontName}'")
        if el.defaultColor:
            styles.append(f'color: {el.defaultColor}')
        if el.lineHeight:
            styles.append(f'line-height: {el.lineHeight}')
            
        style_str = '; '.join(styles)
        content = el.content or ''
        
        return f'''  <div 
    class="ppt-element ppt-text" 
    data-id="{el.id}" 
    data-type="text"
    style="{style_str}">
    {content}
  </div>\n'''
    
    def _element_to_html_shape(self, el: ElementData) -> str:
        """å½¢çŠ¶å…ƒç´ è½¬HTML"""
        styles = [
            'position: absolute',
            f'left: {el.left}px',
            f'top: {el.top}px',
            f'width: {el.width}px',
            f'height: {el.height}px',
            f'transform: rotate({el.rotate}deg)',
        ]
        
        if el.fill:
            styles.append(f'background-color: {el.fill}')
        if el.outline:
            # è§£æoutlineå¯¹è±¡ï¼ˆå¦‚æœæ˜¯å­—å…¸ï¼‰
            if isinstance(el.outline, dict):
                color = el.outline.get('color', '#000')
                width = el.outline.get('width', 1)
                styles.append(f'border: {width}px solid {color}')
            else:
                styles.append(f'border: 1px solid {el.outline}')
                
        style_str = '; '.join(styles)
        text_content = el.text or ''
        
        return f'''  <div 
    class="ppt-element ppt-shape" 
    data-id="{el.id}" 
    data-type="shape"
    style="{style_str}">
    <div class="shape-text">{text_content}</div>
  </div>\n'''
    
    def _element_to_html_image(self, el: ElementData) -> str:
        """å›¾ç‰‡å…ƒç´ è½¬HTML"""
        styles = [
            'position: absolute',
            f'left: {el.left}px',
            f'top: {el.top}px',
            f'width: {el.width}px',
            f'height: {el.height}px',
            'object-fit: cover',
        ]
        
        if el.rotate:
            styles.append(f'transform: rotate({el.rotate}deg)')
            
        style_str = '; '.join(styles)
        src = el.src or ''
        
        return f'''  <img 
    class="ppt-element ppt-image" 
    data-id="{el.id}" 
    data-type="image"
    src="{src}"
    style="{style_str}"
  />\n'''
    
    def _build_system_prompt(self) -> str:
        """
        æ„å»ºç³»ç»Ÿæç¤ºè¯
        ä½¿ç”¨HTMLæ–¹å¼ï¼Œåˆ©ç”¨LLMæ“…é•¿HTMLçš„ç‰¹æ€§
        """
        # TODO: ä»prompts/layout_optimization/system_prompt.ymlåŠ è½½
        return """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ¼”ç¤ºæ–‡ç¨¿è®¾è®¡ä¸“å®¶ï¼Œæ“…é•¿ä¼˜åŒ–PowerPointå¹»ç¯ç‰‡çš„å¸ƒå±€ã€‚

# ä»»åŠ¡
ä½ å°†æ”¶åˆ°ä¸€ä¸ªå¹»ç¯ç‰‡çš„HTMLè¡¨ç¤ºï¼Œéœ€è¦ä¼˜åŒ–å…¶å¸ƒå±€ï¼Œä½¿å…¶æ›´å…·è§†è§‰å¸å¼•åŠ›å’Œä¸“ä¸šæ€§ã€‚

# æ ¸å¿ƒåŸåˆ™
1. **å†…å®¹ç»å¯¹ä¸å˜**ï¼šæ‰€æœ‰æ–‡å­—å†…å®¹ã€data-idå±æ€§å¿…é¡»å®Œå…¨ä¿æŒåŸæ ·
2. **è§†è§‰å±‚æ¬¡**ï¼šé€šè¿‡å­—ä½“å¤§å°ã€ä½ç½®ã€é¢œè‰²å»ºç«‹æ¸…æ™°çš„è§†è§‰å±‚æ¬¡
3. **å¯¹é½åŸåˆ™**ï¼šç¡®ä¿å…ƒç´ ä¹‹é—´çš„å¯¹é½å…³ç³»ï¼ˆå·¦å¯¹é½ã€å±…ä¸­ã€å³å¯¹é½ï¼‰
4. **ç•™ç™½ç©ºé—´**ï¼šåˆç†åˆ©ç”¨ç•™ç™½ï¼Œé¿å…è¿‡åº¦æ‹¥æŒ¤ï¼Œæå‡å‘¼å¸æ„Ÿ
5. **å¹³è¡¡å¸ƒå±€**ï¼šç¡®ä¿è§†è§‰é‡å¿ƒå¹³è¡¡ï¼Œå…ƒç´ åˆ†å¸ƒåˆç†

# ä¼˜åŒ–æ–¹å¼
- è°ƒæ•´å…ƒç´ çš„ position (left, top)
- è°ƒæ•´å…ƒç´ çš„ size (width, height)
- è°ƒæ•´å­—ä½“æ ·å¼ (font-size, font-weight, line-height, text-align)
- è°ƒæ•´é¢œè‰² (color, background-color)
- æ·»åŠ è§†è§‰å¢å¼º (box-shadow, border-radius)

# ä¸¥æ ¼çº¦æŸ
- âœ… å¿…é¡»ä¿æŒæ‰€æœ‰ data-id å±æ€§ä¸å˜
- âœ… å¿…é¡»ä¿æŒæ‰€æœ‰æ–‡æœ¬å†…å®¹ä¸å˜
- âœ… å¿…é¡»ä¿æŒå…ƒç´ çš„ data-type å±æ€§ä¸å˜
- âœ… è¿”å›å®Œæ•´çš„HTMLç»“æ„

# è¾“å‡ºæ ¼å¼
ç›´æ¥è¿”å›ä¼˜åŒ–åçš„HTMLä»£ç ï¼Œæ— éœ€ä»»ä½•è§£é‡Šè¯´æ˜ã€‚åªè¿”å›ä» <div class="ppt-canvas"> å¼€å§‹åˆ° </div> ç»“æŸçš„å®Œæ•´HTMLç»“æ„ã€‚"""
    
    def _build_user_prompt(
        self,
        llm_input: Dict[str, Any],
        options: Optional[OptimizationOptions]
    ) -> str:
        """æ„å»ºç”¨æˆ·æç¤ºè¯"""
        requirements = []
        if options:
            if options.keep_colors:
                requirements.append("- ä¿æŒåŸæœ‰é¢œè‰²æ–¹æ¡ˆ")
            if options.keep_fonts:
                requirements.append("- ä¿æŒåŸæœ‰å­—ä½“")
            requirements.append(f"- ä¼˜åŒ–é£æ ¼ï¼š{options.style}")
        else:
            requirements.append("- éµå¾ªä¸“ä¸šè®¾è®¡åŸåˆ™")
        
        requirements_text = "\n".join(requirements)
        
        return f"""è¯·ä¼˜åŒ–ä»¥ä¸‹å¹»ç¯ç‰‡çš„å¸ƒå±€è®¾è®¡ï¼š

## ç”»å¸ƒä¿¡æ¯
- å®½åº¦ï¼š{llm_input['canvas']['width']}px
- é«˜åº¦ï¼š{llm_input['canvas']['height']}px

## å½“å‰å…ƒç´ å¸ƒå±€
```json
{json.dumps(llm_input['elements'], indent=2, ensure_ascii=False)}
```

## ä¼˜åŒ–è¦æ±‚
{requirements_text}

è¯·è¿”å›JSONæ ¼å¼çš„ä¼˜åŒ–ç»“æœï¼š
```json
{{
  "optimized_elements": [
    {{
      "id": "å…ƒç´ IDï¼ˆå¿…é¡»ä¸åŸå§‹IDä¸€è‡´ï¼‰",
      "position": {{ "x": æ•°å€¼, "y": æ•°å€¼ }},
      "size": {{ "width": æ•°å€¼, "height": æ•°å€¼ }},
      "style": {{
        "font": "å­—ä½“åç§°",
        "fontSize": æ•°å€¼,
        "color": "#é¢œè‰²å€¼"
      }}
    }}
  ],
  "optimization_notes": "ä¼˜åŒ–è¯´æ˜"
}}
```

æ³¨æ„ï¼š
1. ä¿æŒæ‰€æœ‰å…ƒç´ çš„IDä¸å˜
2. ç¡®ä¿å…ƒç´ ä¸è¶…å‡ºç”»å¸ƒèŒƒå›´
3. æ–‡å­—å†…å®¹ç»å¯¹ä¸èƒ½ä¿®æ”¹
4. è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼"""
    
    def _parse_llm_response(self, response: str) -> Dict[str, Any]:
        """è§£æLLMå“åº”"""
        try:
            # 1. æå–JSONä»£ç å—
            json_match = re.search(
                r'```json\s*(.*?)\s*```',
                response,
                re.DOTALL
            )
            
            if json_match:
                json_str = json_match.group(1)
            else:
                json_str = response
            
            # 2. è§£æJSON
            parsed = json.loads(json_str)
            
            # 3. éªŒè¯å¿…è¦å­—æ®µ
            if "optimized_elements" not in parsed:
                raise ValueError("å“åº”ä¸­ç¼ºå°‘optimized_elementså­—æ®µ")
            
            return parsed
            
        except json.JSONDecodeError as e:
            logger.error(
                "è§£æLLMå“åº”å¤±è´¥",
                operation="parse_llm_response_failed",
                error=str(e),
                response_preview=response[:200]
            )
            raise ValueError(f"æ— æ³•è§£æLLMå“åº”ï¼š{str(e)}")
    
    def _convert_to_frontend_format(
        self,
        optimized_data: Dict[str, Any],
        original_elements: List[ElementData]
    ) -> List[ElementData]:
        """è½¬æ¢å›å‰ç«¯æ ¼å¼"""
        # åˆ›å»ºåŸå§‹å…ƒç´ çš„æ˜ å°„
        element_map = {el.id: el for el in original_elements}
        
        optimized_elements = []
        
        for opt_el in optimized_data["optimized_elements"]:
            el_id = opt_el["id"]
            if el_id not in element_map:
                logger.warning(
                    "ä¼˜åŒ–ç»“æœä¸­åŒ…å«æœªçŸ¥å…ƒç´ ID",
                    element_id=el_id
                )
                continue
            
            # è·å–åŸå§‹å…ƒç´ 
            original_el = element_map[el_id]
            
            # æ›´æ–°ä½ç½®å’Œå°ºå¯¸
            updated_el = original_el.model_copy(update={
                "left": opt_el["position"]["x"],
                "top": opt_el["position"]["y"],
                "width": opt_el["size"]["width"],
                "height": opt_el["size"]["height"],
            })
            
            # æ›´æ–°æ ·å¼ï¼ˆå¦‚æœæœ‰ä¸”æœªè®¾ç½®keep_fonts/keep_colorsï¼‰
            if "style" in opt_el and original_el.type == "text":
                if "font" in opt_el["style"]:
                    updated_el.defaultFontName = opt_el["style"]["font"]
                if "color" in opt_el["style"]:
                    updated_el.defaultColor = opt_el["style"]["color"]
                if "lineHeight" in opt_el["style"]:
                    updated_el.lineHeight = opt_el["style"]["lineHeight"]
            
            # æ›´æ–°å¡«å……è‰²
            if "fill" in opt_el and original_el.type == "shape":
                updated_el.fill = opt_el["fill"]
            
            optimized_elements.append(updated_el)
        
        return optimized_elements
    
    def _validate_optimized_elements(
        self,
        optimized: List[ElementData],
        original: List[ElementData]
    ):
        """éªŒè¯ä¼˜åŒ–ç»“æœï¼ˆç¡®ä¿å†…å®¹ä¸å˜ã€IDä¸€è‡´ï¼‰"""
        # 1. å…ƒç´ æ•°é‡åº”è¯¥ä¸€è‡´
        if len(optimized) != len(original):
            raise ValueError(
                f"ä¼˜åŒ–åå…ƒç´ æ•°é‡({len(optimized)})ä¸åŸå§‹æ•°é‡({len(original)})ä¸åŒ¹é…"
            )
        
        # 2. æ‰€æœ‰å…ƒç´ IDåº”è¯¥ä¿æŒä¸€è‡´
        original_ids = {el.id for el in original}
        optimized_ids = {el.id for el in optimized}
        
        if original_ids != optimized_ids:
            missing = original_ids - optimized_ids
            extra = optimized_ids - original_ids
            raise ValueError(
                f"å…ƒç´ IDä¸åŒ¹é…ï¼šç¼ºå¤±{missing}ï¼Œå¤šä½™{extra}"
            )
        
        # 3. éªŒè¯æ–‡æœ¬å†…å®¹æœªè¢«ä¿®æ”¹
        for orig_el in original:
            if orig_el.type == "text" and orig_el.content:
                opt_el = next((el for el in optimized if el.id == orig_el.id), None)
                if opt_el and opt_el.content != orig_el.content:
                    logger.warning(
                        "æ–‡æœ¬å†…å®¹è¢«ä¿®æ”¹ï¼Œå·²æ¢å¤åŸå§‹å†…å®¹",
                        element_id=orig_el.id
                    )
                    # å¼ºåˆ¶æ¢å¤åŸå§‹å†…å®¹
                    opt_el.content = orig_el.content
```

---

## 6. é”™è¯¯å¤„ç†å’Œå®¹é”™

### 6.1 é”™è¯¯ç å®šä¹‰

```python
# backend/app/core/error_codes.py

class LayoutOptimizationErrorCodes:
    """å¸ƒå±€ä¼˜åŒ–é”™è¯¯ç """
    
    # å‚æ•°éªŒè¯é”™è¯¯
    INVALID_REQUEST = "LAYOUT_INVALID_REQUEST"
    TOO_MANY_ELEMENTS = "LAYOUT_TOO_MANY_ELEMENTS"
    INVALID_CANVAS_SIZE = "LAYOUT_INVALID_CANVAS_SIZE"
    
    # ä¸šåŠ¡é€»è¾‘é”™è¯¯
    OPTIMIZATION_FAILED = "LAYOUT_OPTIMIZATION_FAILED"
    LLM_CALL_FAILED = "LAYOUT_LLM_CALL_FAILED"
    PARSE_FAILED = "LAYOUT_PARSE_FAILED"
    VALIDATION_FAILED = "LAYOUT_VALIDATION_FAILED"
    
    # ç³»ç»Ÿé”™è¯¯
    TIMEOUT = "LAYOUT_TIMEOUT"
    CACHE_ERROR = "LAYOUT_CACHE_ERROR"
    INTERNAL_ERROR = "LAYOUT_INTERNAL_ERROR"
```

### 6.2 é™çº§ç­–ç•¥

```python
# Serviceå±‚å®ç°é™çº§é€»è¾‘
async def optimize_layout_with_fallback(
    self,
    slide_id: str,
    elements: List[ElementData],
    canvas_size: CanvasSize,
    options: Optional[OptimizationOptions] = None
) -> List[ElementData]:
    """å¸¦é™çº§ç­–ç•¥çš„ä¼˜åŒ–æ–¹æ³•"""
    try:
        # å°è¯•LLMä¼˜åŒ–
        return await self.optimize_layout(slide_id, elements, canvas_size, options)
        
    except Exception as e:
        logger.warning(
            "LLMä¼˜åŒ–å¤±è´¥ï¼Œè¿”å›åŸå§‹å…ƒç´ ",
            operation="optimize_layout_fallback",
            slide_id=slide_id,
            error=str(e)
        )
        
        # é™çº§ï¼šç›´æ¥è¿”å›åŸå§‹å…ƒç´ 
        return elements
```

---

## 7. æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 7.1 ç¼“å­˜ç­–ç•¥ï¼ˆç¬¬äºŒé˜¶æ®µå®ç°ï¼‰

```python
# Handlerå±‚å®ç°
import redis.asyncio as redis

class LayoutOptimizationHandler:
    
    async def _get_from_cache(self, cache_key: str) -> Optional[LayoutOptimizationResponseData]:
        """ä»Redisè·å–ç¼“å­˜"""
        try:
            redis_client = await redis.from_url("redis://localhost")
            cached_json = await redis_client.get(cache_key)
            
            if cached_json:
                data = json.loads(cached_json)
                return LayoutOptimizationResponseData(**data)
                
        except Exception as e:
            logger.warning(
                "ç¼“å­˜è¯»å–å¤±è´¥",
                operation="cache_get_failed",
                cache_key=cache_key,
                error=str(e)
            )
        
        return None
    
    async def _save_to_cache(
        self,
        cache_key: str,
        result: LayoutOptimizationResponseData,
        ttl: int = 3600
    ):
        """å­˜å‚¨åˆ°Redisç¼“å­˜"""
        try:
            redis_client = await redis.from_url("redis://localhost")
            await redis_client.setex(
                cache_key,
                ttl,
                result.model_dump_json()
            )
            
        except Exception as e:
            logger.warning(
                "ç¼“å­˜å­˜å‚¨å¤±è´¥",
                operation="cache_save_failed",
                cache_key=cache_key,
                error=str(e)
            )
```

### 7.2 å¹¶å‘æ§åˆ¶ï¼ˆç¬¬äºŒé˜¶æ®µå®ç°ï¼‰

```python
# Serviceå±‚å®ç°
import asyncio

# å…¨å±€ä¿¡å·é‡ï¼ˆé™åˆ¶å¹¶å‘LLMè°ƒç”¨ï¼‰
_llm_semaphore = asyncio.Semaphore(5)  # æœ€å¤š5ä¸ªå¹¶å‘

async def optimize_layout(self, ...):
    """ä¼˜åŒ–å¸ƒå±€ï¼ˆå¸¦å¹¶å‘æ§åˆ¶ï¼‰"""
    async with _llm_semaphore:
        # LLMè°ƒç”¨é€»è¾‘
        ...
```

---

## 8. æµ‹è¯•æ–¹æ¡ˆ

### 8.1 å•å…ƒæµ‹è¯•

```python
# tests/unit/test_layout_optimization_service.py

import pytest
from app.services.layout.layout_optimization_service import LayoutOptimizationService
from app.schemas.layout_optimization import ElementData, CanvasSize

class TestLayoutOptimizationService:
    
    @pytest.fixture
    async def service(self, db_session):
        return LayoutOptimizationService(db_session)
    
    async def test_convert_to_llm_format(self, service):
        """æµ‹è¯•è½¬æ¢ä¸ºLLMæ ¼å¼"""
        elements = [
            ElementData(
                id="el_001",
                type="text",
                left=100,
                top=50,
                width=600,
                height=80,
                rotate=0,
                content="Test Title"
            )
        ]
        
        llm_input = service._convert_to_llm_format(
            elements,
            CanvasSize(width=1000, height=562.5),
            None
        )
        
        assert llm_input["canvas"]["width"] == 1000
        assert len(llm_input["elements"]) == 1
        assert llm_input["elements"][0]["id"] == "el_001"
```

### 8.2 é›†æˆæµ‹è¯•

```python
# tests/integration/test_layout_optimization_api.py

import pytest
from httpx import AsyncClient

class TestLayoutOptimizationAPI:
    
    async def test_optimize_layout_success(self, client: AsyncClient):
        """æµ‹è¯•å¸ƒå±€ä¼˜åŒ–æˆåŠŸåœºæ™¯"""
        request_data = {
            "slide_id": "slide_001",
            "elements": [
                {
                    "id": "el_001",
                    "type": "text",
                    "left": 100,
                    "top": 50,
                    "width": 600,
                    "height": 80,
                    "rotate": 0,
                    "content": "Test Title"
                }
            ],
            "canvas_size": {
                "width": 1000,
                "height": 562.5
            }
        }
        
        response = await client.post(
            "/api/v1/layout/optimize",
            json=request_data
        )
        
        assert response.status_code == 200
        data = response.json()
        
        # éªŒè¯StandardResponseæ ¼å¼
        assert data["status"] == "success"
        assert "message" in data
        assert "data" in data
        assert "elements" in data["data"]
```

---

## 9. å®æ–½è·¯çº¿å›¾

### 9.1 ç¬¬ä¸€é˜¶æ®µï¼šMVPé—­ç¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

**ç›®æ ‡**ï¼šå®ç°ç«¯åˆ°ç«¯çš„åŸºæœ¬åŠŸèƒ½é—­ç¯

#### å‰ç«¯ä»»åŠ¡
- [ ] åœ¨ `src/configs/api.ts` ä¸­æ·»åŠ  `LAYOUT.OPTIMIZE` é…ç½®
- [ ] åˆ›å»º `src/types/optimization.ts` ç±»å‹å®šä¹‰
- [ ] å®ç° `src/services/optimization.ts` APIæœåŠ¡
- [ ] åˆ›å»º `src/views/Editor/Toolbar/MagicButton.vue` ç»„ä»¶
- [ ] é›†æˆåˆ°ç¼–è¾‘å™¨å·¥å…·æ 
- [ ] åŸºç¡€é”™è¯¯å¤„ç†å’ŒLoadingçŠ¶æ€

#### åç«¯ä»»åŠ¡
- [ ] åˆ›å»º `app/schemas/layout_optimization.py` æ•°æ®æ¨¡å‹
- [ ] å®ç° `app/api/v1/endpoints/layout_optimization.py` ç«¯ç‚¹ï¼ˆè½»è·¯ç”±ï¼‰
- [ ] å®ç° `app/services/layout/layout_optimization_handler.py` Handlerå±‚
- [ ] å®ç° `app/services/layout/layout_optimization_service.py` Serviceå±‚
- [ ] åˆ›å»º `app/prompts/layout_optimization/` æç¤ºè¯æ¨¡æ¿
- [ ] åœ¨ `app/api/v1/router.py` æ³¨å†Œè·¯ç”±

#### éªŒæ”¶æ ‡å‡†
- âœ… ç‚¹å‡»é­”æœ¯æŒ‰é’®èƒ½è§¦å‘ä¼˜åŒ–
- âœ… ä¼˜åŒ–åå…ƒç´ ä½ç½®å’Œæ ·å¼æœ‰å˜åŒ–
- âœ… æ–‡æœ¬å†…å®¹ä¿æŒä¸å˜
- âœ… å…ƒç´ IDå’Œæ•°é‡ä¿æŒä¸€è‡´
- âœ… æ”¯æŒæ’¤é”€æ“ä½œ
- âœ… é”™è¯¯ä¿¡æ¯å‹å¥½æç¤º

### 9.2 ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½å’Œå¯é æ€§å¢å¼º

**ç›®æ ‡**ï¼šæå‡æ€§èƒ½å’Œç¨³å®šæ€§

#### åŠŸèƒ½æ¸…å•
- [ ] Redisç¼“å­˜é›†æˆï¼ˆå†…å®¹å“ˆå¸ŒKeyï¼ŒTTL=1hï¼‰
- [ ] å¹¶å‘æ§åˆ¶ï¼ˆSemaphoreé™åˆ¶â‰¤5å¹¶å‘ï¼‰
- [ ] MLflowè¿½è¸ªé›†æˆï¼ˆè®°å½•æ¨¡å‹è°ƒç”¨å’Œè€—æ—¶ï¼‰
- [ ] é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡æŒ‡æ•°é€€é¿ï¼‰
- [ ] è¶…æ—¶æ§åˆ¶ï¼ˆ30ç§’ï¼‰

### 9.3 ç¬¬ä¸‰é˜¶æ®µï¼šåŠŸèƒ½æ‰©å±•ï¼ˆå¯é€‰ï¼‰

- [ ] æ‰¹é‡ä¼˜åŒ–æ¥å£
- [ ] æ›´å¤šä¼˜åŒ–é£æ ¼é€‰é¡¹
- [ ] ä¼˜åŒ–æ•ˆæœé¢„è§ˆå¯¹æ¯”
- [ ] ç”¨æˆ·åå¥½è®¾ç½®

---

## é™„å½•

### A. å…³é”®æ–‡ä»¶æ¸…å•

#### å‰ç«¯æ–‡ä»¶
- `frontend/src/configs/api.ts` - APIç«¯ç‚¹é…ç½®ï¼ˆæ·»åŠ LAYOUTé…ç½®ï¼‰
- `frontend/src/types/optimization.ts` - ç±»å‹å®šä¹‰
- `frontend/src/services/optimization.ts` - APIæœåŠ¡
- `frontend/src/views/Editor/Toolbar/MagicButton.vue` - é­”æœ¯æŒ‰é’®ç»„ä»¶

#### åç«¯æ–‡ä»¶
- `backend/app/schemas/layout_optimization.py` - Pydanticæ¨¡å‹
- `backend/app/api/v1/endpoints/layout_optimization.py` - APIç«¯ç‚¹
- `backend/app/services/layout/layout_optimization_handler.py` - Handlerå±‚
- `backend/app/services/layout/layout_optimization_service.py` - Serviceå±‚
- `backend/app/prompts/layout_optimization/system_prompt.txt` - ç³»ç»Ÿæç¤ºè¯
- `backend/app/prompts/layout_optimization/user_prompt.txt` - ç”¨æˆ·æç¤ºè¯æ¨¡æ¿

### B. APIè§„èŒƒå‚è€ƒ
- [APIå“åº”ä¸æ—¥å¿—è§„èŒƒ](../../standard/APIå“åº”ä¸æ—¥å¿—è§„èŒƒ.md)
- [APIè®¾è®¡ä¸å®ç°è§„èŒƒ](../../standard/APIè®¾è®¡ä¸å®ç°è§„èŒƒ.md)

### C. è¯„å®¡æŠ¥å‘Š
- [æ¶æ„è¯„å®¡æŠ¥å‘Š](./æ¶æ„è¯„å®¡æŠ¥å‘Š.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AIå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-28  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.1 (è¯„å®¡åå®Œå–„ç‰ˆ)  
**çŠ¶æ€**: å·²è¯„å®¡ï¼Œç¬¦åˆé¡¹ç›®è§„èŒƒï¼Œå¯å¼€å§‹å¼€å‘

